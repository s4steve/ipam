<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPAM // Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;500;600;700;800&family=Fragment+Mono&family=Overpass:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-void:    #040810;
  --bg-base:    #070d1a;
  --bg-surface: #0b1320;
  --bg-raised:  #101c2c;
  --bg-hover:   #162334;
  --border-dim: #0d1928;
  --border:     #162238;
  --border-hi:  #214060;
  --text:       #c8dff2;
  --text-2:     #527898;
  --text-3:     #274060;
  --accent:     #f56420;
  --accent-lo:  rgba(245,100,32,.10);
  --accent-glow:rgba(245,100,32,.28);
  --cyan:       #00d8ff;
  --cyan-lo:    rgba(0,216,255,.10);
  --cyan-glow:  rgba(0,216,255,.22);
  --green:      #00c878;
  --green-hi:   #00ff9a;
  --amber:      #ffaa00;
  --red:        #ff3f4a;
  --red-lo:     rgba(255,63,74,.10);
  --font-ui:    'Oxanium', sans-serif;
  --font-body:  'Overpass', sans-serif;
  --font-mono:  'Fragment Mono', monospace;
  --r: 6px;
}

html, body { height: 100%; background: var(--bg-void); color: var(--text); font-family: var(--font-body); font-size: 14px; line-height: 1.5; overflow-x: hidden; }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: var(--bg-surface); }
::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 2px; }

body::before {
  content: ''; position: fixed; inset: 0;
  background-image: linear-gradient(rgba(245,100,32,.04) 1px, transparent 1px), linear-gradient(90deg, rgba(245,100,32,.04) 1px, transparent 1px);
  background-size: 44px 44px; background-position: -1px -1px;
  pointer-events: none; z-index: 0;
}

/* ── TOPBAR ── */
.topbar {
  position: sticky; top: 0; z-index: 100;
  display: flex; align-items: center; height: 52px;
  background: rgba(7,13,26,.92); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border); padding: 0 20px; overflow: hidden;
}
.topbar::after {
  content: ''; position: absolute; left: 0; right: 0; bottom: 0; height: 1px;
  background: linear-gradient(90deg, transparent 0%, var(--accent) 35%, var(--cyan) 65%, transparent 100%);
  opacity: .5;
}
.logo {
  display: flex; align-items: center; gap: 9px;
  font-family: var(--font-ui); font-size: 14px; font-weight: 700; letter-spacing: .07em;
  text-transform: uppercase; color: var(--text); cursor: pointer; margin-right: 24px;
  white-space: nowrap; user-select: none; text-decoration: none;
}
.logo-mark {
  width: 26px; height: 26px; background: var(--accent); border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; font-weight: 800; letter-spacing: .04em; color: #fff;
  box-shadow: 0 0 12px var(--accent-glow); flex-shrink: 0;
}
.topbar-nav { display: flex; gap: 1px; flex: 1; }
.nav-btn {
  padding: 5px 12px; border-radius: 5px;
  font-family: var(--font-ui); font-size: 11px; font-weight: 500; letter-spacing: .05em;
  text-transform: uppercase; color: var(--text-2); background: none; border: none;
  cursor: pointer; transition: color .15s, background .15s;
}
.nav-btn:hover { color: var(--text); background: var(--bg-raised); }
.nav-btn.active { color: var(--accent); background: var(--accent-lo); }
.topbar-right { display: flex; align-items: center; gap: 8px; }
.health-pill {
  display: flex; align-items: center; gap: 5px;
  font-family: var(--font-mono); font-size: 10px; color: var(--text-2);
  padding: 4px 9px; border-radius: 20px; border: 1px solid var(--border);
  cursor: pointer; transition: border-color .15s;
}
.health-pill:hover { border-color: var(--border-hi); }
.hdot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-3); transition: background .3s; }
.hdot.ok  { background: var(--green-hi); box-shadow: 0 0 5px var(--green-hi); animation: pulse 2.5s ease-in-out infinite; }
.hdot.err { background: var(--red); box-shadow: 0 0 5px var(--red); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.35} }
.key-btn {
  display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 5px;
  border: 1px solid var(--border); background: var(--bg-surface);
  color: var(--text-2); font-family: var(--font-body); font-size: 11px;
  cursor: pointer; transition: all .15s;
}
.key-btn:hover { border-color: var(--border-hi); color: var(--text); }
.key-btn.has-key { border-color: rgba(245,100,32,.4); color: #ff8c50; }

/* ── LAYOUT ── */
.main { position: relative; z-index: 1; max-width: 1380px; margin: 0 auto; padding: 28px 20px 80px; }

/* ── PAGE HEADER ── */
.page-hd { display: flex; align-items: flex-end; justify-content: space-between; margin-bottom: 24px; gap: 14px; }
.page-title { font-family: var(--font-ui); font-size: 24px; font-weight: 700; letter-spacing: -.01em; line-height: 1.1; }
.page-sub { font-size: 12px; color: var(--text-2); margin-top: 3px; }

/* ── STAT CARDS ── */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
.stat-card {
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 18px 20px; position: relative; overflow: hidden;
  transition: border-color .2s;
}
.stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0; transition: opacity .2s;
}
.stat-card:hover { border-color: var(--border-hi); }
.stat-card:hover::before { opacity: 1; }
.stat-lbl { font-family: var(--font-ui); font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: .12em; color: var(--text-3); margin-bottom: 8px; }
.stat-val { font-family: var(--font-ui); font-size: 36px; font-weight: 800; color: var(--text); line-height: 1; }
.stat-sub { font-size: 11px; color: var(--text-2); margin-top: 5px; }

/* ── CARD ── */
.card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; }
.card + .card, .section { margin-top: 16px; }
.card-hd { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); }
.card-title { font-family: var(--font-ui); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .1em; color: var(--text-2); }

/* ── TABLE ── */
.dtbl { width: 100%; border-collapse: collapse; }
.dtbl th {
  padding: 8px 14px; text-align: left;
  font-family: var(--font-ui); font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: .1em;
  color: var(--text-3); border-bottom: 1px solid var(--border); white-space: nowrap;
}
.dtbl td { padding: 10px 14px; border-bottom: 1px solid var(--border-dim); vertical-align: middle; }
.dtbl tbody tr { cursor: pointer; transition: background .1s; position: relative; }
.dtbl tbody tr::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--accent); opacity: 0; transition: opacity .12s; }
.dtbl tbody tr:hover { background: rgba(22,35,52,.6); }
.dtbl tbody tr:hover::before { opacity: 1; }
.dtbl tbody tr:last-child td { border-bottom: none; }
.mono    { font-family: var(--font-mono); font-size: 12px; }
.mono-sm { font-family: var(--font-mono); font-size: 11px; color: var(--text-2); }

/* ── BADGES ── */
.badge { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 3px; font-family: var(--font-ui); font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: .08em; }
.badge-blue  { background: rgba(0,80,180,.15); color: #5a9fff; border: 1px solid rgba(0,100,220,.2); }
.badge-cyan  { background: var(--cyan-lo);     color: #40e8ff; border: 1px solid rgba(0,216,255,.2); }
.badge-green { background: rgba(0,200,120,.1); color: #30e890; border: 1px solid rgba(0,200,120,.2); }
.badge-red   { background: var(--red-lo);      color: #ff7070; border: 1px solid rgba(255,63,74,.2); }
.badge-amber { background: rgba(255,170,0,.1); color: #ffcc50; border: 1px solid rgba(255,170,0,.2); }

/* ── UTIL BAR ── */
.ubar { background: var(--bg-raised); border-radius: 1px; overflow: hidden; }
.ubar-fill { height: 100%; border-radius: 1px; transition: width .8s cubic-bezier(.34,1.56,.64,1); }

/* ── BUTTONS ── */
.btn { display: inline-flex; align-items: center; gap: 5px; padding: 7px 13px; border-radius: var(--r); font-family: var(--font-body); font-size: 13px; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: all .15s; white-space: nowrap; line-height: 1; }
.btn-p { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-p:hover { background: #d45518; box-shadow: 0 0 10px var(--accent-glow); }
.btn-s { background: var(--bg-raised); color: var(--text); border-color: var(--border); }
.btn-s:hover { border-color: var(--border-hi); }
.btn-g { background: transparent; color: var(--text-2); border: none; }
.btn-g:hover { background: var(--bg-raised); color: var(--text); }
.btn-d { background: var(--red-lo); color: #ff7070; border-color: rgba(255,63,74,.22); }
.btn-d:hover { background: rgba(255,63,74,.18); }
.btn-sm { padding: 4px 9px; font-size: 12px; }
.btn-icon { width: 26px; height: 26px; padding: 0; justify-content: center; background: var(--bg-raised); border: 1px solid var(--border); color: var(--text-2); border-radius: 5px; flex-shrink: 0; }
.btn-icon:hover { color: var(--text); border-color: var(--border-hi); }
.btn-icon.del:hover { color: #ff7070; border-color: rgba(255,63,74,.4); background: var(--red-lo); }
.btn:disabled { opacity: .45; cursor: default; pointer-events: none; }

/* ── FORMS ── */
.fg { margin-bottom: 12px; }
.flbl { display: block; font-family: var(--font-ui); font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: .09em; color: var(--text-2); margin-bottom: 4px; }
.finp { width: 100%; padding: 8px 10px; background: var(--bg-raised); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-family: var(--font-body); font-size: 13px; transition: border-color .15s, box-shadow .15s; outline: none; }
.finp:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
.finp::placeholder { color: var(--text-3); }
.finp.fm { font-family: var(--font-mono); font-size: 12px; }
.fhint { font-size: 10px; color: var(--text-3); margin-top: 3px; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

/* ── DRAWER ── */
.overlay { position: fixed; inset: 0; background: rgba(4,8,16,.72); backdrop-filter: blur(4px); z-index: 200; opacity: 0; pointer-events: none; transition: opacity .25s; }
.overlay.open { opacity: 1; pointer-events: all; }
.drawer { position: fixed; top: 0; right: 0; bottom: 0; width: 420px; background: var(--bg-surface); border-left: 1px solid var(--border); z-index: 201; transform: translateX(100%); transition: transform .3s cubic-bezier(.16,1,.3,1); display: flex; flex-direction: column; overflow: hidden; }
.drawer.open { transform: translateX(0); }
.drawer-hd { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.drawer-title { font-family: var(--font-ui); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: .07em; }
.drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
.drawer-foot { padding: 12px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px; flex-shrink: 0; }

/* ── MODAL BASE ── */
.modal-wrap { position: fixed; inset: 0; z-index: 300; display: flex; align-items: center; justify-content: center; background: rgba(4,8,16,.86); backdrop-filter: blur(6px); opacity: 0; pointer-events: none; transition: opacity .2s; }
.modal-wrap.open { opacity: 1; pointer-events: all; }
.modal-box { background: var(--bg-surface); border: 1px solid var(--border-hi); border-radius: 10px; padding: 26px; transform: scale(.95); transition: transform .2s; min-width: 340px; }
.modal-wrap.open .modal-box { transform: scale(1); }
.modal-title { font-family: var(--font-ui); font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; margin-bottom: 18px; }

/* ── CONFIRM MODAL ── */
.confirm-box { max-width: 360px; text-align: center; }
.confirm-icon { font-size: 28px; margin-bottom: 12px; }
.confirm-title { font-family: var(--font-ui); font-size: 15px; font-weight: 700; margin-bottom: 8px; }
.confirm-msg { font-size: 13px; color: var(--text-2); margin-bottom: 20px; line-height: 1.6; }
.confirm-btns { display: flex; gap: 8px; justify-content: center; }

/* ── SUBNET CARDS ── */
.sc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
.sc {
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 16px 18px;
  cursor: pointer; transition: border-color .18s, background .18s;
  position: relative; overflow: hidden;
}
.sc::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--accent); opacity: 0; transition: opacity .18s; }
.sc:hover { border-color: var(--border-hi); background: var(--bg-raised); }
.sc:hover::before { opacity: 1; }
.sc-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 4px; opacity: 0; transition: opacity .15s; z-index: 2; }
.sc:hover .sc-actions { opacity: 1; }
.sc-cidr { font-family: var(--font-mono); font-size: 17px; margin-bottom: 2px; padding-right: 60px; }
.sc-name { font-size: 11px; color: var(--text-2); margin-bottom: 12px; min-height: 15px; }
.sc-ubar { height: 2px; background: var(--bg-raised); border-radius: 1px; margin-bottom: 7px; overflow: hidden; }
.sc-fill { height: 100%; border-radius: 1px; transition: width .9s cubic-bezier(.34,1.56,.64,1); }
.sc-stats { display: flex; gap: 12px; font-family: var(--font-ui); font-size: 10px; color: var(--text-2); }
.sc-stats strong { color: var(--text); font-weight: 600; }
.sc-badges { display: flex; gap: 4px; margin-bottom: 8px; }

/* ── ZONE CARDS ── */
.zc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
.zc { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--r); padding: 16px 18px; transition: border-color .18s; }
.zc:hover { border-color: var(--border-hi); }
.zc-name { font-family: var(--font-mono); font-size: 15px; margin-bottom: 2px; }
.zc-desc { font-size: 11px; color: var(--text-2); margin-bottom: 8px; }
.zc-soa { display: grid; grid-template-columns: 1fr 1fr; gap: 3px 12px; margin-top: 8px; }
.zc-row { font-family: var(--font-mono); font-size: 9px; color: var(--text-3); }
.zc-row span { color: var(--text-2); }
hr { border: none; border-top: 1px solid var(--border); margin: 10px 0; }

/* ── DETAIL LAYOUT ── */
.detail-lay { display: grid; grid-template-columns: 1fr 280px; gap: 16px; align-items: start; }
@media (max-width: 820px) { .detail-lay { grid-template-columns: 1fr; } }

/* ── IP GRID ── */
.ipgrid-wrap { padding: 14px; }
.ipgrid-legend { display: flex; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
.ipgrid-legend-item { display: flex; align-items: center; gap: 4px; font-family: var(--font-ui); font-size: 9px; text-transform: uppercase; letter-spacing: .05em; color: var(--text-3); }
.ipgrid-legend-swatch { width: 9px; height: 9px; border-radius: 1px; }
#ip-grid { display: grid; width: fit-content; }
.ipc { border-radius: 1px; cursor: default; transition: transform .06s; }
.ipc:hover { transform: scale(1.7); z-index: 5; position: relative; }
.ipc.free  { background: var(--bg-raised); }
.ipc.alloc { background: var(--cyan); box-shadow: 0 0 2px var(--cyan-glow); }
.ipc.res   { background: var(--border-hi); }

/* ── DETAIL TABLE ── */
.detail-tbl { width: 100%; border-collapse: collapse; }
.detail-tbl td { padding: 5px 0; border-bottom: 1px solid var(--border-dim); }
.detail-tbl td:first-child { font-family: var(--font-ui); font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: .09em; color: var(--text-3); width: 45%; }
.detail-tbl td:last-child { font-family: var(--font-mono); font-size: 10px; text-align: right; }
.detail-tbl tr:last-child td { border-bottom: none; }

/* ── LOADING / EMPTY ── */
.loading, .empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 56px 32px; color: var(--text-3); gap: 8px; text-align: center; }
.spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .55s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-ico  { font-size: 26px; opacity: .2; }
.empty-txt  { font-size: 13px; color: var(--text-2); }
.empty-hint { font-size: 11px; }

/* ── TOAST ── */
#toasts { position: fixed; bottom: 20px; right: 20px; z-index: 500; display: flex; flex-direction: column; gap: 6px; }
.toast { padding: 10px 14px; border-radius: 7px; font-family: var(--font-ui); font-size: 11px; letter-spacing: .02em; background: var(--bg-raised); border: 1px solid var(--border-hi); color: var(--text); box-shadow: 0 6px 24px rgba(0,0,0,.5); animation: tin .25s cubic-bezier(.34,1.56,.64,1) forwards; max-width: 280px; }
.toast.ok  { border-color: rgba(0,200,120,.4); color: #40e890; }
.toast.err { border-color: rgba(255,63,74,.4);  color: #ff7070; }
@keyframes tin { from { opacity:0; transform: translateX(14px) scale(.93); } to { opacity:1; transform: none; } }

/* ── FILTERS ── */
.filters { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.fi { padding: 6px 10px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-family: var(--font-mono); font-size: 11px; outline: none; transition: border-color .15s; min-width: 180px; }
.fi:focus { border-color: var(--accent); }
.fi::placeholder { color: var(--text-3); font-family: var(--font-body); }

/* ── BACK ── */
.back { display: inline-flex; align-items: center; gap: 5px; font-family: var(--font-ui); font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: .07em; color: var(--text-3); cursor: pointer; padding: 4px 0; margin-bottom: 16px; border: none; background: none; transition: color .15s; }
.back:hover { color: var(--text-2); }

/* ── MISC ── */
.err-banner { padding: 9px 12px; background: rgba(255,63,74,.07); border: 1px solid rgba(255,63,74,.2); border-radius: 5px; color: #ff7070; font-size: 12px; margin-bottom: 12px; }
.soa-head { font-family: var(--font-ui); font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: .1em; color: var(--text-3); margin: 14px 0 8px; border-top: 1px solid var(--border-dim); padding-top: 12px; }
.result-box { background: var(--bg-raised); border: 1px solid var(--border-hi); border-radius: 6px; padding: 12px; margin-top: 10px; }
.result-lbl { font-family: var(--font-ui); font-size: 9px; text-transform: uppercase; letter-spacing: .1em; color: var(--text-3); margin-bottom: 5px; }
.result-val { font-family: var(--font-mono); font-size: 20px; color: var(--cyan); }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="logo" onclick="nav('dashboard')">
    <div class="logo-mark">IP</div>
    IPAM
  </div>
  <nav class="topbar-nav">
    <button class="nav-btn" data-v="dashboard" onclick="nav('dashboard')">Dashboard</button>
    <button class="nav-btn" data-v="subnets"   onclick="nav('subnets')">Subnets</button>
    <button class="nav-btn" data-v="ips"        onclick="nav('ips')">IP Addresses</button>
    <button class="nav-btn" data-v="dns"        onclick="nav('dns')">DNS Zones</button>
  </nav>
  <div class="topbar-right">
    <div class="health-pill" onclick="checkHealth()" title="Ping API">
      <div class="hdot" id="hdot"></div>
      <span id="htext">—</span>
    </div>
    <button class="key-btn" id="keybtn" onclick="openCfg()">
      <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 7a2 2 0 0 1 2 2m4 0a6 6 0 0 1-7.743 5.743L11 17H9v2H7v2H4a1 1 0 0 1-1-1v-2.586a1 1 0 0 1 .293-.707l5.964-5.964A6 6 0 1 1 21 9z"/></svg>
      <span id="keylbl">API Key</span>
    </button>
  </div>
</div>

<!-- Main content -->
<main class="main" id="app">
  <div class="loading"><div class="spinner"></div></div>
</main>

<!-- Config modal -->
<div class="modal-wrap" id="cfgwrap">
  <div class="modal-box">
    <div class="modal-title">Connection Settings</div>
    <div class="fg">
      <label class="flbl">API Base URL</label>
      <input class="finp fm" id="cfg-base" placeholder="http://localhost:8000">
      <div class="fhint">URL where the IPAM server is running</div>
    </div>
    <div class="fg">
      <label class="flbl">API Key</label>
      <input class="finp fm" id="cfg-key" type="password" placeholder="your-api-key-here">
      <div class="fhint">Set via IPAM_API_KEY on the server</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:20px">
      <button class="btn btn-p" style="flex:1" onclick="saveCfg()">Save &amp; Connect</button>
      <button class="btn btn-s" onclick="closeCfg()">Cancel</button>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div class="modal-wrap" id="confirmwrap">
  <div class="modal-box confirm-box">
    <div class="confirm-icon" id="confirm-icon">⚠</div>
    <div class="confirm-title" id="confirm-title">Confirm</div>
    <div class="confirm-msg" id="confirm-msg"></div>
    <div class="confirm-btns">
      <button class="btn" id="confirm-ok" onclick="execConfirm()">Confirm</button>
      <button class="btn btn-s" onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<!-- Drawer -->
<div class="overlay" id="doverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-hd">
    <div class="drawer-title" id="dtitle">—</div>
    <button class="btn btn-icon" onclick="closeDrawer()">
      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </button>
  </div>
  <div class="drawer-body" id="dbody"></div>
  <div class="drawer-foot" id="dfoot"></div>
</div>

<div id="toasts"></div>

<script>
'use strict';

// ─── STATE ────────────────────────────────────────────────────────
const S = {
  key:  localStorage.getItem('ipam_key')  || '',
  base: localStorage.getItem('ipam_base') || 'http://localhost:8000',
  view: 'dashboard',
  vp:   {},
  subnets: null,
  ips:     null,
  zones:   null,
  dSubnet: null,
  dIPs:    null,
};

// ─── API ──────────────────────────────────────────────────────────
async function api(method, path, body = null) {
  const url = S.base.replace(/\/$/, '') + path;
  const headers = { 'Content-Type': 'application/json' };
  if (S.key) headers['Authorization'] = 'Bearer ' + S.key;
  const opts = { method, headers };
  if (body !== null) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if (res.status === 204) return null;
  const data = await res.json().catch(() => null);
  if (!res.ok) {
    const detail = data?.detail;
    const msg = Array.isArray(detail)
      ? detail.map(d => d.msg || JSON.stringify(d)).join('; ')
      : (detail || `HTTP ${res.status}`);
    throw new Error(msg);
  }
  return data;
}

async function checkHealth() {
  try {
    await api('GET', '/health');
    document.getElementById('hdot').className = 'hdot ok';
    document.getElementById('htext').textContent = 'online';
    return true;
  } catch {
    document.getElementById('hdot').className = 'hdot err';
    document.getElementById('htext').textContent = 'offline';
    return false;
  }
}

// ─── NAVIGATION ───────────────────────────────────────────────────
function nav(view, params = {}) {
  S.view = view; S.vp = params;
  document.querySelectorAll('.nav-btn').forEach(el => {
    el.classList.toggle('active',
      el.dataset.v === view || (view === 'subnet-detail' && el.dataset.v === 'subnets'));
  });
  render();
}

// ─── HELPERS ──────────────────────────────────────────────────────
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
function set(html) { document.getElementById('app').innerHTML = html; }
function spinnerPage() { set('<div class="loading"><div class="spinner"></div></div>'); }

function uColor(pct) {
  if (pct >= .95) return 'var(--red)';
  if (pct >= .75) return 'var(--amber)';
  return 'var(--green)';
}
function uPct(s) { return s.usable_hosts ? s.allocated_count / s.usable_hosts : 0; }
function uBar(s, h = 3) {
  const p = Math.min(100, Math.round(uPct(s) * 100));
  return `<div class="ubar" style="height:${h}px"><div class="ubar-fill" style="width:${p}%;background:${uColor(uPct(s))}"></div></div>`;
}
function badge(txt, type = 'blue') { return `<span class="badge badge-${type}">${txt}</span>`; }

// ─── CONFIRM MODAL ────────────────────────────────────────────────
let _confirmCb = null;
function openConfirm(title, msg, callback, btnLabel = 'Delete', btnClass = 'btn-d') {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').innerHTML = msg;
  const ok = document.getElementById('confirm-ok');
  ok.textContent = btnLabel;
  ok.className = 'btn ' + btnClass;
  ok.style.display = callback ? '' : 'none';
  _confirmCb = callback;
  document.getElementById('confirmwrap').classList.add('open');
}
function closeConfirm() {
  document.getElementById('confirmwrap').classList.remove('open');
  _confirmCb = null;
}
function execConfirm() {
  const cb = _confirmCb;
  closeConfirm();
  if (cb) cb();
}

// ─── CONFIG ───────────────────────────────────────────────────────
function openCfg() {
  document.getElementById('cfg-base').value = S.base;
  document.getElementById('cfg-key').value  = S.key;
  document.getElementById('cfgwrap').classList.add('open');
}
function closeCfg() { document.getElementById('cfgwrap').classList.remove('open'); }
function saveCfg() {
  S.base = document.getElementById('cfg-base').value.trim() || 'http://localhost:8000';
  S.key  = document.getElementById('cfg-key').value.trim();
  localStorage.setItem('ipam_base', S.base);
  localStorage.setItem('ipam_key',  S.key);
  updateKeyBtn(); closeCfg(); checkHealth(); render();
}
function updateKeyBtn() {
  const btn = document.getElementById('keybtn');
  const lbl = document.getElementById('keylbl');
  if (S.key) { btn.classList.add('has-key'); lbl.textContent = S.key.slice(0, 10) + '…'; }
  else        { btn.classList.remove('has-key'); lbl.textContent = 'API Key'; }
}

// ─── DRAWER ───────────────────────────────────────────────────────
function openDrawer(title, body, foot = '') {
  document.getElementById('dtitle').textContent = title;
  document.getElementById('dbody').innerHTML = body;
  document.getElementById('dfoot').innerHTML = foot;
  document.getElementById('drawer').classList.add('open');
  document.getElementById('doverlay').classList.add('open');
}
function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('doverlay').classList.remove('open');
}

// ─── TOAST ────────────────────────────────────────────────────────
function toast(msg, type = '', dur = 3200) {
  const c = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(() => el.remove(), dur);
}

// ─── RENDER DISPATCHER ────────────────────────────────────────────
async function render() {
  switch (S.view) {
    case 'dashboard':     await renderDash(); break;
    case 'subnets':       await renderSubnets(); break;
    case 'subnet-detail': await renderSubnetDetail(); break;
    case 'ips':           await renderIPs(); break;
    case 'dns':           await renderDNS(); break;
  }
}

// ─── COUNTER ANIMATION ────────────────────────────────────────────
function countTo(id, target, suffix = '') {
  const el = document.getElementById(id);
  if (!el) return;
  let cur = 0;
  const step = Math.max(1, Math.ceil(target / 40));
  const t = setInterval(() => {
    cur = Math.min(cur + step, target);
    el.textContent = cur.toLocaleString() + suffix;
    if (cur >= target) clearInterval(t);
  }, 18);
}

// ─────────────────────────────────────────────────────────────────
// DASHBOARD
// ─────────────────────────────────────────────────────────────────
async function renderDash() {
  spinnerPage();
  try {
    const [subnets, ips, zones] = await Promise.all([
      api('GET', '/subnets/?limit=500'),
      api('GET', '/ip-addresses/?limit=1000'),
      api('GET', '/dns-zones/?limit=500'),
    ]);
    S.subnets = subnets; S.ips = ips; S.zones = zones;
    const totalUsable = subnets.reduce((a, s) => a + s.usable_hosts, 0);
    const utilPct = totalUsable > 0 ? Math.round(ips.length / totalUsable * 100) : 0;
    const ipv6n   = subnets.filter(s => s.is_ipv6).length;
    const dnsIPs  = ips.filter(i => i.dns_name).length;

    const subnetRows = subnets.slice(0, 6).map(s => `
      <tr onclick="nav('subnet-detail',{id:${s.id}})">
        <td class="mono">${esc(s.cidr)}</td>
        <td>${esc(s.name)}</td>
        <td style="min-width:90px">${uBar(s)}</td>
        <td class="mono-sm">${s.allocated_count}</td>
        <td class="mono-sm">${s.free_count}</td>
        <td>${badge(s.is_ipv6 ? 'IPv6' : 'IPv4', s.is_ipv6 ? 'cyan' : 'blue')}</td>
      </tr>`).join('');

    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">Network Overview</div>
          <div class="page-sub">${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}</div>
        </div>
      </div>
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-lbl">Subnets</div>
          <div class="stat-val" id="sv-sub">0</div>
          <div class="stat-sub">${ipv6n} IPv6 · ${subnets.length - ipv6n} IPv4</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">Allocated IPs</div>
          <div class="stat-val" id="sv-ip">0</div>
          <div class="stat-sub">of ${totalUsable.toLocaleString()} usable</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">DNS Zones</div>
          <div class="stat-val" id="sv-dns">0</div>
          <div class="stat-sub">${dnsIPs} IPs with names</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">Utilization</div>
          <div class="stat-val" id="sv-util">0%</div>
          <div class="stat-sub">${(totalUsable - ips.length).toLocaleString()} addresses free</div>
        </div>
      </div>
      ${subnets.length > 0 ? `
      <div class="card">
        <div class="card-hd">
          <div class="card-title">Subnets</div>
          <button class="btn btn-s btn-sm" onclick="nav('subnets')">View all →</button>
        </div>
        <table class="dtbl">
          <thead><tr><th>CIDR</th><th>Name</th><th>Utilization</th><th>Alloc</th><th>Free</th><th>Type</th></tr></thead>
          <tbody>${subnetRows}</tbody>
        </table>
      </div>` : `
      <div class="card"><div class="empty">
        <div class="empty-ico">⬡</div>
        <div class="empty-txt">No subnets yet</div>
        <div class="empty-hint">Create your first subnet to begin</div>
        <button class="btn btn-p" style="margin-top:10px" onclick="nav('subnets')">Create Subnet</button>
      </div></div>`}
    `);
    countTo('sv-sub',  subnets.length);
    countTo('sv-ip',   ips.length);
    countTo('sv-dns',  zones.length);
    countTo('sv-util', utilPct, '%');
  } catch (e) {
    set(`<div class="err-banner">${esc(e.message)}</div>`);
  }
}

// ─────────────────────────────────────────────────────────────────
// SUBNETS LIST
// ─────────────────────────────────────────────────────────────────
async function renderSubnets() {
  spinnerPage();
  try {
    const subnets = await api('GET', '/subnets/?limit=500');
    S.subnets = subnets;
    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">Subnets</div>
          <div class="page-sub">${subnets.length} subnet${subnets.length !== 1 ? 's' : ''}</div>
        </div>
        <button class="btn btn-p" onclick="openCreateSubnet()">
          <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          New Subnet
        </button>
      </div>
      ${subnets.length === 0
        ? `<div class="card"><div class="empty">
             <div class="empty-ico">⬡</div>
             <div class="empty-txt">No subnets configured</div>
             <div class="empty-hint">Add your first subnet to start tracking IP space</div>
             <button class="btn btn-p" style="margin-top:10px" onclick="openCreateSubnet()">Create First Subnet</button>
           </div></div>`
        : `<div class="sc-grid">${subnets.map(scCard).join('')}</div>`
      }
    `);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

function scCard(s) {
  const p = Math.min(100, Math.round(uPct(s) * 100));
  const c = uColor(uPct(s));
  const utilBadge = p >= 95 ? badge('FULL', 'red') : p >= 75 ? badge('HIGH', 'amber') : '';
  return `
  <div class="sc" onclick="nav('subnet-detail',{id:${s.id}})">
    <div class="sc-actions">
      <button class="btn btn-icon btn-sm" title="Edit subnet"
        onclick="event.stopPropagation();openEditSubnet(${s.id})">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </button>
      <button class="btn btn-icon btn-sm del" title="Delete subnet"
        onclick="event.stopPropagation();delSubnet(${s.id},'${esc(s.cidr)}',${s.allocated_count})">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
      </button>
    </div>
    <div class="sc-cidr">${esc(s.cidr)}</div>
    <div class="sc-name">${esc(s.name)}${s.description ? ' — ' + esc(s.description) : ''}</div>
    <div class="sc-badges">${utilBadge} ${badge(s.is_ipv6 ? 'IPv6' : 'IPv4', s.is_ipv6 ? 'cyan' : 'blue')}</div>
    <div class="sc-ubar"><div class="sc-fill" style="width:${p}%;background:${c}"></div></div>
    <div class="sc-stats">
      <span><strong>${s.allocated_count}</strong> alloc</span>
      <span><strong>${s.free_count}</strong> free</span>
      <span><strong>${p}%</strong> used</span>
    </div>
  </div>`;
}

// ─────────────────────────────────────────────────────────────────
// SUBNET DETAIL
// ─────────────────────────────────────────────────────────────────
async function renderSubnetDetail() {
  const id = S.vp.id;
  spinnerPage();
  try {
    const [subnet, ips] = await Promise.all([
      api('GET', `/subnets/${id}`),
      api('GET', `/ip-addresses/?subnet_id=${id}&limit=1000`),
    ]);
    S.dSubnet = subnet; S.dIPs = ips;
    const p    = uPct(subnet);
    const c    = uColor(p);
    const pPct = Math.min(100, Math.round(p * 100));
    const showGrid = !subnet.is_ipv6 && subnet.total_hosts <= 4096;

    const ipRows = ips.map(ip => `
      <tr>
        <td class="mono">${esc(ip.address)}</td>
        <td class="mono-sm">${ip.dns_name ? esc(ip.dns_name) : '<span style="color:var(--text-3)">—</span>'}</td>
        <td style="color:var(--text-2);font-size:12px">${ip.description ? esc(ip.description) : '<span style="color:var(--text-3)">—</span>'}</td>
        <td style="text-align:right;white-space:nowrap">
          <button class="btn btn-icon btn-sm" title="Edit" onclick="openEditIP(${ip.id})">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
          <button class="btn btn-icon btn-sm del" title="Delete" style="margin-left:3px" onclick="delIP(${ip.id},'${esc(ip.address)}')">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
          </button>
        </td>
      </tr>`).join('');

    set(`
      <button class="back" onclick="nav('subnets')">
        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"/></svg>
        Back to Subnets
      </button>
      <div class="page-hd">
        <div>
          <div class="page-title" style="font-family:var(--font-mono);font-size:22px">${esc(subnet.cidr)}</div>
          <div class="page-sub">${esc(subnet.name)}${subnet.description ? ' — ' + esc(subnet.description) : ''}</div>
        </div>
        <div style="display:flex;gap:7px;flex-wrap:wrap;align-items:center">
          <button class="btn btn-p btn-sm" onclick="openAllocate(${subnet.id})">
            <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            Allocate Next IP
          </button>
          <button class="btn btn-s btn-sm" onclick="openAddIP(${subnet.id})">Add Specific IP</button>
          <button class="btn btn-s btn-sm" onclick="openEditSubnet(${subnet.id})" title="Edit subnet">
            <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Edit
          </button>
          <button class="btn btn-d btn-sm" onclick="delSubnet(${subnet.id},'${esc(subnet.cidr)}',${subnet.allocated_count})" title="Delete subnet">
            <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
            Delete
          </button>
        </div>
      </div>

      <div class="detail-lay">
        <div>
          <div class="card">
            <div class="card-hd">
              <div class="card-title">Allocated Addresses</div>
              ${badge(ips.length + ' allocated', 'blue')}
            </div>
            ${ips.length === 0
              ? `<div class="empty" style="padding:40px">
                   <div class="empty-txt">No IPs allocated</div>
                   <div class="empty-hint">Use "Allocate Next IP" to assign addresses from this subnet</div>
                 </div>`
              : `<table class="dtbl">
                   <thead><tr><th>Address</th><th>DNS Name</th><th>Description</th><th style="text-align:right">Actions</th></tr></thead>
                   <tbody>${ipRows}</tbody>
                 </table>`}
          </div>
        </div>

        <div>
          <div class="card" style="margin-bottom:14px">
            <div class="card-hd"><div class="card-title">Subnet Details</div></div>
            <div style="padding:14px 16px">
              <div style="margin-bottom:10px">
                ${uBar(subnet, 5)}
                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-2);margin-top:5px">
                  <span>${subnet.allocated_count} / ${subnet.usable_hosts} usable</span>
                  <span style="color:${c};font-weight:600">${pPct}%</span>
                </div>
              </div>
              <table class="detail-tbl">
                ${[
                  ['Netmask',    subnet.netmask],
                  ['Broadcast',  subnet.broadcast],
                  ['1st Usable', subnet.first_usable],
                  ['Last Usable',subnet.last_usable],
                  ['Total',      subnet.total_hosts.toLocaleString()],
                  ['Usable',     subnet.usable_hosts.toLocaleString()],
                  ['Free',       subnet.free_count.toLocaleString()],
                  ['Type',       subnet.is_ipv6 ? 'IPv6' : 'IPv4'],
                ].map(([k,v]) => `<tr><td>${k}</td><td>${esc(String(v))}</td></tr>`).join('')}
              </table>
            </div>
          </div>

          ${showGrid ? `
          <div class="card">
            <div class="card-hd">
              <div class="card-title">Address Map</div>
              <div style="font-size:10px;color:var(--text-3)">${subnet.total_hosts} addrs</div>
            </div>
            <div class="ipgrid-wrap">
              <div class="ipgrid-legend">
                <div class="ipgrid-legend-item"><div class="ipgrid-legend-swatch" style="background:var(--bg-raised);border:1px solid var(--border)"></div>Free</div>
                <div class="ipgrid-legend-item"><div class="ipgrid-legend-swatch" style="background:var(--cyan);box-shadow:0 0 3px var(--cyan-glow)"></div>Alloc</div>
                <div class="ipgrid-legend-item"><div class="ipgrid-legend-swatch" style="background:var(--border-hi)"></div>Reserved</div>
              </div>
              <div id="ip-grid"></div>
            </div>
          </div>` : ''}
        </div>
      </div>
    `);
    if (showGrid) buildGrid(subnet, ips);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

// ─── IP GRID BUILDER ──────────────────────────────────────────────
function ip4ToInt(ip) { return ip.split('.').reduce((a, o) => (a << 8) + parseInt(o), 0) >>> 0; }
function intToIP4(n)  { return [(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,n&255].join('.'); }
function intToHex32(n){ return '0'.repeat(24) + ((n >>> 0).toString(16).padStart(8, '0')); }

function buildGrid(subnet, ips) {
  const el = document.getElementById('ip-grid');
  if (!el) return;
  const allocMap = new Map(ips.map(ip => [ip.address, ip]));
  const [addrPart, prefixStr] = subnet.cidr.split('/');
  const prefix = parseInt(prefixStr);
  const base   = ip4ToInt(addrPart);
  const total  = subnet.total_hosts;
  const cols   = total <= 16 ? 4 : total <= 64 ? 8 : total <= 256 ? 16 : total <= 1024 ? 32 : 64;
  const sz     = total <= 256 ? 12 : total <= 1024 ? 7 : 4;
  const gap    = sz >= 7 ? 2 : 1;
  el.style.gridTemplateColumns = `repeat(${cols}, ${sz}px)`;
  el.style.gap = `${gap}px`;
  const frag = document.createDocumentFragment();
  for (let i = 0; i < total; i++) {
    const ipInt = base + i;
    const hex   = intToHex32(ipInt);
    const cell  = document.createElement('div');
    cell.className = 'ipc';
    cell.style.width = cell.style.height = sz + 'px';
    const isNet  = i === 0;
    const isBrdc = i === total - 1 && prefix < 31;
    if (isNet || isBrdc) {
      cell.classList.add('res');
      cell.title = intToIP4(ipInt) + (isNet ? ' (network)' : ' (broadcast)');
    } else if (allocMap.has(hex)) {
      const ipd = allocMap.get(hex);
      cell.classList.add('alloc');
      cell.title = ipd.address + (ipd.dns_name ? '\n' + ipd.dns_name : '') + (ipd.description ? '\n' + ipd.description : '');
    } else {
      cell.classList.add('free');
      cell.title = intToIP4(ipInt);
    }
    frag.appendChild(cell);
  }
  el.appendChild(frag);
}

// ─────────────────────────────────────────────────────────────────
// IP ADDRESSES LIST
// ─────────────────────────────────────────────────────────────────
async function renderIPs() {
  spinnerPage();
  try {
    const [ips, subs] = await Promise.all([
      api('GET', '/ip-addresses/?limit=1000'),
      S.subnets ? Promise.resolve(S.subnets) : api('GET', '/subnets/?limit=500'),
    ]);
    if (!S.subnets) S.subnets = subs;
    const smap = new Map(subs.map(s => [s.id, s]));
    window._allIPs = ips; window._smap = smap;

    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">IP Addresses</div>
          <div class="page-sub">${ips.length} address${ips.length !== 1 ? 'es' : ''} allocated</div>
        </div>
      </div>
      <div class="filters">
        <input class="fi" placeholder="Filter by address…"  id="fa" oninput="filterIPs()">
        <input class="fi" placeholder="Filter by DNS name…" id="fd" oninput="filterIPs()">
      </div>
      ${ips.length === 0
        ? `<div class="card"><div class="empty">
             <div class="empty-ico">◎</div>
             <div class="empty-txt">No IPs allocated</div>
             <div class="empty-hint">Allocate IPs from a subnet to see them here</div>
           </div></div>`
        : `<div class="card">
             <table class="dtbl">
               <thead><tr><th>Address</th><th>Subnet</th><th>DNS Name</th><th>Description</th><th>Type</th><th style="text-align:right">Actions</th></tr></thead>
               <tbody id="iptbody">${ips.map(ip => ipRow(ip, smap)).join('')}</tbody>
             </table>
           </div>`
      }
    `);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

function ipRow(ip, smap) {
  const sub = smap?.get(ip.subnet_id);
  return `<tr data-addr="${esc(ip.address)}" data-dns="${esc(ip.dns_name || '')}">
    <td class="mono">${esc(ip.address)}</td>
    <td class="mono-sm">${sub ? esc(sub.cidr) : '#' + ip.subnet_id}</td>
    <td class="mono-sm">${ip.dns_name ? esc(ip.dns_name) : '<span style="color:var(--text-3)">—</span>'}</td>
    <td style="color:var(--text-2);font-size:12px">${ip.description ? esc(ip.description) : '<span style="color:var(--text-3)">—</span>'}</td>
    <td>${badge(ip.is_ipv6 ? 'IPv6' : 'IPv4', ip.is_ipv6 ? 'cyan' : 'blue')}</td>
    <td style="text-align:right;white-space:nowrap">
      <button class="btn btn-icon btn-sm" title="Edit" onclick="openEditIP(${ip.id})">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </button>
      <button class="btn btn-icon btn-sm del" title="Delete" style="margin-left:3px" onclick="delIP(${ip.id},'${esc(ip.address)}')">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
      </button>
    </td>
  </tr>`;
}

function filterIPs() {
  const fa = (document.getElementById('fa')?.value || '').toLowerCase();
  const fd = (document.getElementById('fd')?.value || '').toLowerCase();
  document.querySelectorAll('#iptbody tr').forEach(r => {
    const show = (!fa || (r.dataset.addr || '').includes(fa))
              && (!fd || (r.dataset.dns  || '').includes(fd));
    r.style.display = show ? '' : 'none';
  });
}

// ─────────────────────────────────────────────────────────────────
// DNS ZONES
// ─────────────────────────────────────────────────────────────────
async function renderDNS() {
  spinnerPage();
  try {
    const zones = await api('GET', '/dns-zones/?limit=500');
    S.zones = zones;
    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">DNS Zones</div>
          <div class="page-sub">${zones.length} zone${zones.length !== 1 ? 's' : ''}</div>
        </div>
        <button class="btn btn-p" onclick="openCreateDNS()">
          <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          New Zone
        </button>
      </div>
      ${zones.length === 0
        ? `<div class="card"><div class="empty">
             <div class="empty-ico">◑</div>
             <div class="empty-txt">No DNS zones</div>
             <div class="empty-hint">DNS zones are required to assign DNS names to IP addresses</div>
             <button class="btn btn-p" style="margin-top:10px" onclick="openCreateDNS()">Create First Zone</button>
           </div></div>`
        : `<div class="zc-grid">${zones.map(zCard).join('')}</div>`
      }
    `);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

function zCard(z) {
  return `
  <div class="zc">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="zc-name">${esc(z.name)}</div>
        ${z.description ? `<div class="zc-desc">${esc(z.description)}</div>` : ''}
      </div>
      <div style="display:flex;gap:5px;flex-shrink:0">
        <button class="btn btn-icon btn-sm" title="Edit" onclick="openEditDNS(${z.id})">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn btn-icon btn-sm del" title="Delete" onclick="delDNS(${z.id},'${esc(z.name)}')">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
        </button>
      </div>
    </div>
    <hr>
    <div class="zc-soa">
      <div class="zc-row">MNAME <span>${esc(z.soa.mname)}</span></div>
      <div class="zc-row">RNAME <span>${esc(z.soa.rname)}</span></div>
      <div class="zc-row">Serial <span>${z.soa.serial}</span></div>
      <div class="zc-row">Refresh <span>${z.soa.refresh}s</span></div>
      <div class="zc-row">Retry <span>${z.soa.retry}s</span></div>
      <div class="zc-row">Expire <span>${z.soa.expire}s</span></div>
    </div>
  </div>`;
}

// ─────────────────────────────────────────────────────────────────
// SUBNET CRUD FORMS
// ─────────────────────────────────────────────────────────────────

function openCreateSubnet() {
  openDrawer('New Subnet', `
    <div class="fg">
      <label class="flbl">CIDR Notation *</label>
      <input class="finp fm" id="f-cidr" placeholder="192.168.1.0/24">
      <div class="fhint">IPv4 or IPv6, e.g. 10.0.0.0/8 or 2001:db8::/32</div>
    </div>
    <div class="fg">
      <label class="flbl">Name *</label>
      <input class="finp" id="f-name" placeholder="e.g. Corporate LAN">
    </div>
    <div class="fg">
      <label class="flbl">Description</label>
      <input class="finp" id="f-desc" placeholder="Optional description">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `, `
    <button class="btn btn-p" style="flex:1" onclick="submitCreateSubnet()">Create Subnet</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}

async function submitCreateSubnet() {
  const cidr = document.getElementById('f-cidr').value.trim();
  const name = document.getElementById('f-name').value.trim();
  const desc = document.getElementById('f-desc').value.trim();
  const err  = document.getElementById('ferr');
  err.style.display = 'none';
  if (!cidr || !name) { err.textContent = 'CIDR and Name are required'; err.style.display = 'block'; return; }
  try {
    await api('POST', '/subnets/', { cidr, name, description: desc || null });
    closeDrawer(); toast('Subnet created', 'ok'); S.subnets = null;
    await renderSubnets();
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

function openEditSubnet(id) {
  const s = (S.subnets || []).find(s => s.id === id) || S.dSubnet;
  openDrawer('Edit Subnet', `
    <div style="font-family:var(--font-mono);font-size:17px;color:var(--text);margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border)">${s ? esc(s.cidr) : '#' + id}</div>
    <div class="fg">
      <label class="flbl">Name *</label>
      <input class="finp" id="f-name" value="${esc(s?.name || '')}" placeholder="Subnet name">
    </div>
    <div class="fg">
      <label class="flbl">Description</label>
      <input class="finp" id="f-desc" value="${esc(s?.description || '')}" placeholder="Optional description">
      <div class="fhint">Leave blank to clear</div>
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `, `
    <button class="btn btn-p" style="flex:1" onclick="submitEditSubnet(${id})">Save Changes</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}

async function submitEditSubnet(id) {
  const name = document.getElementById('f-name').value.trim();
  const desc = document.getElementById('f-desc').value.trim();
  const err  = document.getElementById('ferr');
  err.style.display = 'none';
  if (!name) { err.textContent = 'Name is required'; err.style.display = 'block'; return; }
  try {
    await api('PUT', `/subnets/${id}`, { name, description: desc || null });
    closeDrawer(); toast('Subnet updated', 'ok'); S.subnets = null;
    if (S.view === 'subnet-detail') await renderSubnetDetail();
    else await renderSubnets();
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

function delSubnet(id, cidr, allocCount) {
  if (allocCount > 0) {
    openConfirm(
      'Cannot Delete Subnet',
      `<strong style="font-family:var(--font-mono)">${esc(cidr)}</strong> contains <strong>${allocCount}</strong> allocated IP address${allocCount !== 1 ? 'es' : ''}.<br><br>Release all addresses before deleting this subnet.`,
      null,
      'OK',
      'btn-s'
    );
    return;
  }
  openConfirm(
    'Delete Subnet',
    `Permanently delete subnet <strong style="font-family:var(--font-mono)">${esc(cidr)}</strong>?<br>This action cannot be undone.`,
    async () => {
      try {
        await api('DELETE', `/subnets/${id}`);
        toast(`${cidr} deleted`, 'ok'); S.subnets = null;
        if (S.view === 'subnet-detail') nav('subnets');
        else await renderSubnets();
      } catch (e) { toast(e.message, 'err'); }
    },
    'Delete',
    'btn-d'
  );
}

// ─────────────────────────────────────────────────────────────────
// ALLOCATE / ADD IP FORMS
// ─────────────────────────────────────────────────────────────────

function openAllocate(subnetId) {
  openDrawer('Allocate Next IP', `
    <p style="font-size:12px;color:var(--text-2);margin-bottom:16px">
      Assigns the lowest available address in <strong style="font-family:var(--font-mono)">${esc(S.dSubnet?.cidr || '')}</strong>.
    </p>
    <div class="fg">
      <label class="flbl">DNS Name (optional)</label>
      <input class="finp fm" id="f-dns" placeholder="host.example.com">
      <div class="fhint">Must belong to an existing DNS zone</div>
    </div>
    <div class="fg">
      <label class="flbl">Description (optional)</label>
      <input class="finp" id="f-desc" placeholder="Purpose or owner of this address">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
    <div id="fresult" style="display:none" class="result-box">
      <div class="result-lbl">Allocated Address</div>
      <div class="result-val" id="fresult-addr">—</div>
    </div>
  `, `
    <button class="btn btn-p" id="fsub" style="flex:1" onclick="submitAllocate(${subnetId})">Allocate IP</button>
    <button class="btn btn-s" onclick="closeDrawer()">Done</button>
  `);
}

async function submitAllocate(subnetId) {
  const dns  = document.getElementById('f-dns').value.trim();
  const desc = document.getElementById('f-desc').value.trim();
  const err  = document.getElementById('ferr');
  err.style.display = 'none';
  try {
    const r = await api('POST', `/subnets/${subnetId}/allocate`, { dns_name: dns || null, description: desc || null });
    document.getElementById('fresult').style.display = 'block';
    document.getElementById('fresult-addr').textContent = r.address;
    document.getElementById('fsub').disabled = true;
    toast('Allocated ' + r.address, 'ok');
    setTimeout(async () => { closeDrawer(); await renderSubnetDetail(); }, 1600);
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

function openAddIP(subnetId) {
  openDrawer('Add Specific IP', `
    <div class="fg">
      <label class="flbl">IP Address *</label>
      <input class="finp fm" id="f-addr" placeholder="192.168.1.42">
    </div>
    <div class="fg">
      <label class="flbl">DNS Name (optional)</label>
      <input class="finp fm" id="f-dns" placeholder="host.example.com">
    </div>
    <div class="fg">
      <label class="flbl">Description (optional)</label>
      <input class="finp" id="f-desc" placeholder="">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `, `
    <button class="btn btn-p" style="flex:1" onclick="submitAddIP(${subnetId})">Add IP</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}

async function submitAddIP(subnetId) {
  const address = document.getElementById('f-addr').value.trim();
  const dns     = document.getElementById('f-dns').value.trim();
  const desc    = document.getElementById('f-desc').value.trim();
  const err     = document.getElementById('ferr');
  err.style.display = 'none';
  if (!address) { err.textContent = 'IP address is required'; err.style.display = 'block'; return; }
  try {
    await api('POST', '/ip-addresses/', { address, subnet_id: subnetId, dns_name: dns || null, description: desc || null });
    closeDrawer(); toast('IP address added', 'ok'); await renderSubnetDetail();
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

// ─────────────────────────────────────────────────────────────────
// EDIT / DELETE IP
// ─────────────────────────────────────────────────────────────────

async function openEditIP(ipId) {
  let ip = (S.dIPs || []).find(i => i.id === ipId) || (S.ips || []).find(i => i.id === ipId);
  if (!ip) { try { ip = await api('GET', `/ip-addresses/${ipId}`); } catch(e) { toast(e.message, 'err'); return; } }
  openDrawer(`Edit ${ip.address}`, `
    <div style="font-family:var(--font-mono);font-size:17px;color:var(--text);margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border)">${esc(ip.address)}</div>
    <div class="fg">
      <label class="flbl">DNS Name</label>
      <input class="finp fm" id="f-dns" value="${esc(ip.dns_name || '')}" placeholder="host.example.com">
      <div class="fhint">Clear to remove DNS association</div>
    </div>
    <div class="fg">
      <label class="flbl">Description</label>
      <input class="finp" id="f-desc" value="${esc(ip.description || '')}" placeholder="">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `, `
    <button class="btn btn-p" style="flex:1" onclick="submitEditIP(${ip.id})">Save Changes</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}

async function submitEditIP(ipId) {
  const dns  = document.getElementById('f-dns').value.trim();
  const desc = document.getElementById('f-desc').value.trim();
  const err  = document.getElementById('ferr');
  err.style.display = 'none';
  try {
    await api('PUT', `/ip-addresses/${ipId}`, { dns_name: dns || null, description: desc || null });
    closeDrawer(); toast('Updated', 'ok');
    if (S.view === 'subnet-detail') await renderSubnetDetail(); else await renderIPs();
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

async function delIP(ipId, address) {
  openConfirm(
    'Release IP Address',
    `Release <strong style="font-family:var(--font-mono)">${esc(address)}</strong>?<br>This frees the address for future allocation.`,
    async () => {
      try {
        await api('DELETE', `/ip-addresses/${ipId}`);
        toast(address + ' released', 'ok');
        if (S.view === 'subnet-detail') await renderSubnetDetail(); else await renderIPs();
      } catch (e) { toast(e.message, 'err'); }
    },
    'Release',
    'btn-d'
  );
}

// ─────────────────────────────────────────────────────────────────
// DNS ZONE FORMS
// ─────────────────────────────────────────────────────────────────

function dnsForm(z = null) {
  const s = z?.soa || {};
  return `
    <div class="fg">
      <label class="flbl">Zone Name *</label>
      <input class="finp fm" id="f-zname" value="${esc(z?.name || '')}" placeholder="example.com">
    </div>
    <div class="fg">
      <label class="flbl">Description</label>
      <input class="finp" id="f-zdesc" value="${esc(z?.description || '')}" placeholder="">
    </div>
    <div class="soa-head">SOA Record</div>
    <div class="grid2">
      <div class="fg">
        <label class="flbl">MNAME *</label>
        <input class="finp fm" id="f-mname" value="${esc(s.mname || '')}" placeholder="ns1.example.com">
        <div class="fhint">Primary nameserver</div>
      </div>
      <div class="fg">
        <label class="flbl">RNAME *</label>
        <input class="finp fm" id="f-rname" value="${esc(s.rname || '')}" placeholder="hostmaster.example.com">
        <div class="fhint">Responsible party</div>
      </div>
    </div>
    <div class="grid3">
      <div class="fg">
        <label class="flbl">Serial</label>
        <input class="finp fm" id="f-serial"  type="number" value="${s.serial  ?? 1}">
      </div>
      <div class="fg">
        <label class="flbl">Refresh (s)</label>
        <input class="finp fm" id="f-refresh" type="number" value="${s.refresh ?? 3600}">
      </div>
      <div class="fg">
        <label class="flbl">Retry (s)</label>
        <input class="finp fm" id="f-retry"   type="number" value="${s.retry   ?? 600}">
      </div>
    </div>
    <div class="grid2">
      <div class="fg">
        <label class="flbl">Expire (s)</label>
        <input class="finp fm" id="f-expire"  type="number" value="${s.expire  ?? 604800}">
      </div>
      <div class="fg">
        <label class="flbl">Minimum (s)</label>
        <input class="finp fm" id="f-minimum" type="number" value="${s.minimum ?? 86400}">
      </div>
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `;
}

function getDNSData() {
  return {
    name:        document.getElementById('f-zname').value.trim(),
    description: document.getElementById('f-zdesc').value.trim() || null,
    soa: {
      mname:   document.getElementById('f-mname').value.trim(),
      rname:   document.getElementById('f-rname').value.trim(),
      serial:  parseInt(document.getElementById('f-serial').value)  || 1,
      refresh: parseInt(document.getElementById('f-refresh').value) || 3600,
      retry:   parseInt(document.getElementById('f-retry').value)   || 600,
      expire:  parseInt(document.getElementById('f-expire').value)  || 604800,
      minimum: parseInt(document.getElementById('f-minimum').value) || 86400,
    },
  };
}

function openCreateDNS() {
  openDrawer('New DNS Zone', dnsForm(), `
    <button class="btn btn-p" style="flex:1" onclick="submitCreateDNS()">Create Zone</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}
async function submitCreateDNS() {
  const d = getDNSData(); const err = document.getElementById('ferr'); err.style.display = 'none';
  if (!d.name || !d.soa.mname || !d.soa.rname) { err.textContent = 'Name, MNAME and RNAME are required'; err.style.display = 'block'; return; }
  try { await api('POST', '/dns-zones/', d); closeDrawer(); toast('Zone created', 'ok'); await renderDNS(); }
  catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

async function openEditDNS(zoneId) {
  let z = (S.zones || []).find(z => z.id === zoneId);
  if (!z) { try { z = await api('GET', `/dns-zones/${zoneId}`); } catch(e) { toast(e.message, 'err'); return; } }
  openDrawer(`Edit ${z.name}`, dnsForm(z), `
    <button class="btn btn-p" style="flex:1" onclick="submitEditDNS(${z.id})">Save Changes</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}
async function submitEditDNS(zoneId) {
  const d = getDNSData(); const err = document.getElementById('ferr'); err.style.display = 'none';
  try { await api('PUT', `/dns-zones/${zoneId}`, d); closeDrawer(); toast('Zone updated', 'ok'); await renderDNS(); }
  catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

async function delDNS(zoneId, name) {
  openConfirm(
    'Delete DNS Zone',
    `Delete zone <strong style="font-family:var(--font-mono)">${esc(name)}</strong>?<br>IP addresses using this zone will not be automatically updated.`,
    async () => {
      try { await api('DELETE', `/dns-zones/${zoneId}`); toast(`'${name}' deleted`, 'ok'); await renderDNS(); }
      catch (e) { toast(e.message, 'err'); }
    },
    'Delete',
    'btn-d'
  );
}

// ─── INIT ─────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', async () => {
  updateKeyBtn();
  await checkHealth();
  nav('dashboard');
});
</script>
</body>
</html>
