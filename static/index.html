<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPAM // Control</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-void:    #030810;
  --bg-base:    #060e1e;
  --bg-surface: #0b1628;
  --bg-raised:  #122034;
  --bg-hover:   #192a40;
  --border-dim: #121f33;
  --border:     #1c2e48;
  --border-hi:  #2a4468;
  --text:       #dce9f6;
  --text-2:     #7a92ac;
  --text-3:     #3a536a;
  --accent:     #1d6cf5;
  --accent-lo:  rgba(29,108,245,0.15);
  --accent-glow:rgba(29,108,245,0.35);
  --cyan:       #07b6d5;
  --cyan-lo:    rgba(7,182,213,0.15);
  --cyan-glow:  rgba(7,182,213,0.3);
  --green:      #0ea872;
  --green-bright:#22d48f;
  --amber:      #e09220;
  --red:        #e03b3b;
  --red-lo:     rgba(224,59,59,0.12);
  --font-ui:   'Syne', sans-serif;
  --font-body: 'DM Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --r:          8px;
}

html, body { height: 100%; background: var(--bg-void); color: var(--text); font-family: var(--font-body); font-size: 14px; line-height: 1.5; overflow-x: hidden; }

::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--bg-surface); }
::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 3px; }

/* Dot-grid background texture */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: radial-gradient(circle, rgba(29,108,245,0.07) 1px, transparent 0);
  background-size: 28px 28px;
  pointer-events: none; z-index: 0;
}

/* ── TOPBAR ─────────────────────────────────────────── */
.topbar {
  position: sticky; top: 0; z-index: 100;
  display: flex; align-items: center; height: 54px;
  background: rgba(6,14,30,0.88);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  overflow: hidden;
}
.topbar::after {
  content: '';
  position: absolute; left: 0; right: 0; bottom: -1px; height: 1px;
  background: linear-gradient(90deg, transparent 0%, var(--accent) 40%, var(--cyan) 60%, transparent 100%);
  opacity: 0.4;
}
.topbar::before {
  content: '';
  position: absolute; left: 0; right: 0; height: 54px;
  background: linear-gradient(to bottom, transparent, rgba(29,108,245,0.035), transparent);
  animation: bar-scan 5s ease-in-out infinite;
  pointer-events: none;
}
@keyframes bar-scan {
  0%,100% { transform: translateY(-54px); opacity: 0; }
  10%,90%  { opacity: 1; }
  50%      { transform: translateY(54px); }
}

.logo {
  display: flex; align-items: center; gap: 10px;
  font-family: var(--font-ui); font-weight: 800; font-size: 16px;
  color: var(--text); text-decoration: none; margin-right: 28px; white-space: nowrap;
  cursor: pointer;
}
.logo-mark {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px; background: var(--accent);
  border-radius: 6px; font-size: 10px; font-weight: 700; letter-spacing: .05em;
  color: #fff; box-shadow: 0 0 14px var(--accent-glow);
}
.logo-slash { color: var(--text-3); margin: 0 2px; }

.topbar-nav { display: flex; gap: 2px; flex: 1; }
.nav-btn {
  padding: 5px 13px; border-radius: 6px;
  font-family: var(--font-ui); font-size: 13px; font-weight: 500;
  color: var(--text-2); cursor: pointer;
  border: none; background: none;
  letter-spacing: .03em; transition: color .15s, background .15s;
}
.nav-btn:hover { color: var(--text); background: var(--bg-raised); }
.nav-btn.active {
  color: var(--text); background: var(--accent-lo);
  box-shadow: inset 0 0 0 1px rgba(29,108,245,.28);
}

.topbar-right { display: flex; align-items: center; gap: 10px; }

.health-pill {
  display: flex; align-items: center; gap: 6px;
  font-family: var(--font-mono); font-size: 11px; color: var(--text-2);
  padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border);
  cursor: pointer; transition: border-color .15s;
}
.health-pill:hover { border-color: var(--border-hi); }
.health-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--text-3); transition: background .3s;
}
.health-dot.ok  { background: var(--green-bright); box-shadow: 0 0 6px var(--green-bright); animation: pulse-g 2.5s ease-in-out infinite; }
.health-dot.err { background: var(--red); box-shadow: 0 0 6px var(--red); }
@keyframes pulse-g { 0%,100%{opacity:1}50%{opacity:.4} }

.key-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 12px; border-radius: 6px;
  border: 1px solid var(--border); background: var(--bg-surface);
  color: var(--text-2); font-family: var(--font-body); font-size: 12px;
  cursor: pointer; transition: all .15s;
}
.key-btn:hover { border-color: var(--border-hi); color: var(--text); }
.key-btn.has-key { border-color: rgba(29,108,245,.35); color: #6aa3fa; }

/* ── LAYOUT ─────────────────────────────────────────── */
.main { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 32px 24px 80px; }

/* ── PAGE HEADER ─────────────────────────────────────── */
.page-hd {
  display: flex; align-items: flex-end; justify-content: space-between;
  margin-bottom: 28px; gap: 16px;
}
.page-title { font-family: var(--font-ui); font-size: 26px; font-weight: 700; letter-spacing: -.02em; line-height: 1.1; }
.page-sub   { font-size: 13px; color: var(--text-2); margin-top: 4px; }

/* ── STAT CARDS ──────────────────────────────────────── */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 28px; }
.stat-card {
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 20px 22px;
  position: relative; overflow: hidden; transition: border-color .2s;
}
.stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0; transition: opacity .2s;
}
.stat-card:hover { border-color: var(--border-hi); }
.stat-card:hover::before { opacity: 1; }
.stat-lbl { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .1em; color: var(--text-3); margin-bottom: 6px; }
.stat-val { font-family: var(--font-ui); font-size: 38px; font-weight: 700; color: var(--text); line-height: 1; }
.stat-sub { font-size: 11px; color: var(--text-2); margin-top: 5px; }

/* ── CARD ────────────────────────────────────────────── */
.card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; }
.card + .card, .section { margin-top: 20px; }
.card-hd {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px; border-bottom: 1px solid var(--border);
}
.card-title { font-family: var(--font-ui); font-size: 13px; font-weight: 600; letter-spacing: .03em; }

/* ── TABLE ───────────────────────────────────────────── */
.dtbl { width: 100%; border-collapse: collapse; }
.dtbl th {
  padding: 9px 16px; text-align: left;
  font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .09em;
  color: var(--text-3); border-bottom: 1px solid var(--border); white-space: nowrap;
}
.dtbl td { padding: 11px 16px; border-bottom: 1px solid var(--border-dim); vertical-align: middle; }
.dtbl tbody tr { cursor: pointer; transition: background .1s; position: relative; }
.dtbl tbody tr::after {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px;
  background: var(--accent); opacity: 0; transition: opacity .12s;
}
.dtbl tbody tr:hover { background: rgba(25,42,64,.55); }
.dtbl tbody tr:hover::after { opacity: 1; }
.dtbl tbody tr:last-child td { border-bottom: none; }

.mono { font-family: var(--font-mono); font-size: 12px; }
.mono-sm { font-family: var(--font-mono); font-size: 11px; color: var(--text-2); }

/* ── BADGES ──────────────────────────────────────────── */
.badge {
  display: inline-flex; align-items: center;
  padding: 2px 7px; border-radius: 4px;
  font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: .07em;
}
.badge-blue { background: var(--accent-lo); color: #7ab3ff; border: 1px solid rgba(29,108,245,.22); }
.badge-cyan { background: var(--cyan-lo); color: #2de5ff; border: 1px solid rgba(7,182,213,.22); }
.badge-green{ background: rgba(14,168,114,.12); color: #2cd99a; border: 1px solid rgba(14,168,114,.22); }
.badge-red  { background: var(--red-lo); color: #f07070; border: 1px solid rgba(224,59,59,.2); }
.badge-amber{ background: rgba(224,146,32,.1); color: #f0ba60; border: 1px solid rgba(224,146,32,.2); }

/* ── UTIL BAR ────────────────────────────────────────── */
.ubar { height: 3px; background: var(--bg-raised); border-radius: 2px; overflow: hidden; }
.ubar-fill { height: 100%; border-radius: 2px; transition: width .8s cubic-bezier(.34,1.56,.64,1); }

/* ── BUTTONS ─────────────────────────────────────────── */
.btn {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 7px 14px; border-radius: 6px;
  font-family: var(--font-body); font-size: 13px; font-weight: 500;
  cursor: pointer; border: 1px solid transparent;
  transition: all .15s; white-space: nowrap;
}
.btn-p { background: var(--accent); color: #fff; border-color: var(--accent); }
.btn-p:hover { background: #1559d4; }
.btn-s { background: var(--bg-raised); color: var(--text); border-color: var(--border); }
.btn-s:hover { border-color: var(--border-hi); }
.btn-g { background: transparent; color: var(--text-2); }
.btn-g:hover { background: var(--bg-raised); color: var(--text); }
.btn-d { background: var(--red-lo); color: #f07070; border-color: rgba(224,59,59,.2); }
.btn-d:hover { background: rgba(224,59,59,.2); }
.btn-sm { padding: 4px 10px; font-size: 12px; }
.btn-icon { width: 28px; height: 28px; padding: 0; justify-content: center; background: var(--bg-raised); border-color: var(--border); color: var(--text-2); border-radius: 6px; }
.btn-icon:hover { color: var(--text); border-color: var(--border-hi); }
.btn:disabled { opacity: .5; cursor: default; }

/* ── FORMS ───────────────────────────────────────────── */
.fg { margin-bottom: 14px; }
.flbl { display: block; font-size: 11px; font-weight: 500; color: var(--text-2); margin-bottom: 5px; letter-spacing: .03em; }
.finp {
  width: 100%; padding: 8px 12px;
  background: var(--bg-raised); border: 1px solid var(--border);
  border-radius: 6px; color: var(--text); font-family: var(--font-body); font-size: 13px;
  transition: border-color .15s; outline: none;
}
.finp:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
.finp::placeholder { color: var(--text-3); }
.finp.fm { font-family: var(--font-mono); font-size: 12px; }
.fhint { font-size: 11px; color: var(--text-3); margin-top: 3px; }
.ferr  { font-size: 11px; color: #f07070; margin-top: 3px; }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

/* ── DRAWER ──────────────────────────────────────────── */
.overlay {
  position: fixed; inset: 0; background: rgba(3,8,16,.75);
  backdrop-filter: blur(3px); z-index: 200;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.overlay.open { opacity: 1; pointer-events: all; }
.drawer {
  position: fixed; top: 0; right: 0; bottom: 0; width: 440px;
  background: var(--bg-surface); border-left: 1px solid var(--border);
  z-index: 201; transform: translateX(100%);
  transition: transform .3s cubic-bezier(.16,1,.3,1);
  display: flex; flex-direction: column; overflow: hidden;
}
.drawer.open { transform: translateX(0); }
.drawer-hd {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 22px; border-bottom: 1px solid var(--border); flex-shrink: 0;
}
.drawer-title { font-family: var(--font-ui); font-size: 15px; font-weight: 600; }
.drawer-body  { flex: 1; overflow-y: auto; padding: 22px; }
.drawer-foot  { padding: 14px 22px; border-top: 1px solid var(--border); display: flex; gap: 8px; flex-shrink: 0; }

/* ── CONFIG MODAL ────────────────────────────────────── */
.cfg-wrap {
  position: fixed; inset: 0; z-index: 300;
  display: flex; align-items: center; justify-content: center;
  background: rgba(3,8,16,.82); backdrop-filter: blur(4px);
  opacity: 0; pointer-events: none; transition: opacity .2s;
}
.cfg-wrap.open { opacity: 1; pointer-events: all; }
.cfg-box {
  background: var(--bg-surface); border: 1px solid var(--border-hi);
  border-radius: 12px; width: 400px; padding: 28px;
  transform: scale(.95); transition: transform .2s;
}
.cfg-wrap.open .cfg-box { transform: scale(1); }
.cfg-title { font-family: var(--font-ui); font-size: 16px; font-weight: 700; margin-bottom: 18px; }

/* ── SUBNET CARDS ────────────────────────────────────── */
.sc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 14px; }
.sc {
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 18px 20px; cursor: pointer;
  transition: border-color .2s, background .2s; position: relative; overflow: hidden;
}
.sc::after {
  content: ''; position: absolute; inset: 0; border-radius: var(--r);
  box-shadow: inset 0 0 0 1px var(--accent); opacity: 0; transition: opacity .2s;
}
.sc:hover { border-color: var(--border-hi); background: var(--bg-raised); }
.sc:hover::after { opacity: .25; }
.sc-cidr { font-family: var(--font-mono); font-size: 19px; font-weight: 500; margin-bottom: 3px; }
.sc-name { font-size: 12px; color: var(--text-2); margin-bottom: 14px; min-height: 16px; }
.sc-ubar { height: 3px; background: var(--bg-raised); border-radius: 2px; margin-bottom: 7px; overflow: hidden; }
.sc-fill  { height: 100%; border-radius: 2px; transition: width .9s cubic-bezier(.34,1.56,.64,1); }
.sc-stats { display: flex; gap: 14px; font-size: 11px; color: var(--text-2); }
.sc-stats strong { color: var(--text); font-weight: 500; }

/* ── ZONE CARDS ──────────────────────────────────────── */
.zc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 14px; }
.zc {
  background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: var(--r); padding: 18px 20px; transition: border-color .2s;
}
.zc:hover { border-color: var(--border-hi); }
.zc-name { font-family: var(--font-mono); font-size: 17px; font-weight: 500; margin-bottom: 3px; }
.zc-desc { font-size: 12px; color: var(--text-2); margin-bottom: 10px; }
.zc-soa  { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 14px; margin-top: 10px; }
.zc-row  { font-size: 10px; color: var(--text-3); font-family: var(--font-mono); }
.zc-row span { color: var(--text-2); }
hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }

/* ── DETAIL LAYOUT ───────────────────────────────────── */
.detail-lay { display: grid; grid-template-columns: 1fr 300px; gap: 20px; align-items: start; }
@media (max-width: 860px) { .detail-lay { grid-template-columns: 1fr; } }

/* ── IP GRID ─────────────────────────────────────────── */
.ipgrid-wrap { padding: 16px; }
.ipgrid-legend { display: flex; gap: 14px; margin-bottom: 10px; flex-wrap: wrap; }
.ipgrid-legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text-3); }
.ipgrid-legend-swatch { width: 10px; height: 10px; border-radius: 2px; }
#ip-grid { display: grid; width: fit-content; }
.ipc {
  border-radius: 1.5px;
  cursor: default;
  transition: transform .08s;
}
.ipc:hover { transform: scale(1.6); z-index: 5; position: relative; }
.ipc.free   { background: var(--bg-raised); }
.ipc.alloc  { background: var(--cyan); box-shadow: 0 0 3px var(--cyan-glow); }
.ipc.res    { background: var(--border-hi); }

/* ── SUBNET DETAILS TABLE ────────────────────────────── */
.detail-tbl { width: 100%; border-collapse: collapse; }
.detail-tbl td { padding: 6px 0; border-bottom: 1px solid var(--border-dim); font-size: 12px; }
.detail-tbl td:first-child { color: var(--text-3); font-size: 10px; text-transform: uppercase; letter-spacing: .08em; font-weight: 600; width: 50%; }
.detail-tbl td:last-child  { font-family: var(--font-mono); font-size: 11px; text-align: right; }
.detail-tbl tr:last-child td { border-bottom: none; }

/* ── LOADING / EMPTY ─────────────────────────────────── */
.loading, .empty {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 60px 32px; color: var(--text-3); gap: 10px; text-align: center;
}
.spinner { width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.empty-ico  { font-size: 28px; opacity: .25; }
.empty-txt  { font-size: 14px; color: var(--text-2); }
.empty-hint { font-size: 12px; }

/* ── TOAST ───────────────────────────────────────────── */
#toasts { position: fixed; bottom: 22px; right: 22px; z-index: 500; display: flex; flex-direction: column; gap: 7px; }
.toast {
  padding: 11px 15px; border-radius: 8px; font-size: 13px;
  background: var(--bg-raised); border: 1px solid var(--border-hi);
  color: var(--text); box-shadow: 0 8px 30px rgba(0,0,0,.5);
  animation: tin .3s cubic-bezier(.34,1.56,.64,1) forwards; max-width: 300px;
}
.toast.ok  { border-color: rgba(14,168,114,.4); }
.toast.err { border-color: rgba(224,59,59,.4); color: #f07070; }
@keyframes tin { from { opacity:0; transform: translateX(16px) scale(.94); } to { opacity:1; transform: none; } }

/* ── FILTERS ─────────────────────────────────────────── */
.filters { display: flex; gap: 9px; margin-bottom: 18px; flex-wrap: wrap; }
.fi {
  padding: 6px 12px; background: var(--bg-surface); border: 1px solid var(--border);
  border-radius: 6px; color: var(--text); font-family: var(--font-mono); font-size: 12px;
  outline: none; transition: border-color .15s; min-width: 200px;
}
.fi:focus { border-color: var(--accent); }
.fi::placeholder { color: var(--text-3); font-family: var(--font-body); }

/* ── BACK ────────────────────────────────────────────── */
.back {
  display: inline-flex; align-items: center; gap: 5px;
  font-size: 12px; color: var(--text-2); cursor: pointer;
  padding: 4px 0; margin-bottom: 18px; border: none; background: none;
  font-family: var(--font-body); transition: color .15s;
}
.back:hover { color: var(--text); }

/* ── INLINE ERR BANNER ───────────────────────────────── */
.err-banner {
  padding: 10px 14px; background: rgba(224,59,59,.08);
  border: 1px solid rgba(224,59,59,.22); border-radius: 6px;
  color: #f07070; font-size: 13px; margin-bottom: 14px;
}
.soa-head { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: var(--text-3); margin: 14px 0 10px; }

/* ── RESULT BOX ──────────────────────────────────────── */
.result-box {
  background: var(--bg-raised); border: 1px solid var(--border-hi);
  border-radius: 8px; padding: 14px; margin-top: 12px;
}
.result-lbl { font-size: 10px; text-transform: uppercase; letter-spacing: .08em; color: var(--text-3); margin-bottom: 6px; }
.result-val { font-family: var(--font-mono); font-size: 22px; color: var(--cyan); }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="logo" onclick="nav('dashboard')">
    <div class="logo-mark">IP</div>
    IPAM<span class="logo-slash">//</span>Control
  </div>
  <nav class="topbar-nav">
    <button class="nav-btn" data-v="dashboard" onclick="nav('dashboard')">Dashboard</button>
    <button class="nav-btn" data-v="subnets"   onclick="nav('subnets')">Subnets</button>
    <button class="nav-btn" data-v="ips"        onclick="nav('ips')">IP Addresses</button>
    <button class="nav-btn" data-v="dns"        onclick="nav('dns')">DNS Zones</button>
  </nav>
  <div class="topbar-right">
    <div class="health-pill" onclick="checkHealth()" title="Click to ping">
      <div class="health-dot" id="hdot"></div>
      <span id="htext" style="font-size:10px">—</span>
    </div>
    <button class="key-btn" id="keybtn" onclick="openCfg()">
      <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 7a2 2 0 0 1 2 2m4 0a6 6 0 0 1-7.743 5.743L11 17H9v2H7v2H4a1 1 0 0 1-1-1v-2.586a1 1 0 0 1 .293-.707l5.964-5.964A6 6 0 1 1 21 9z"/></svg>
      <span id="keylbl">Set API Key</span>
    </button>
  </div>
</div>

<!-- Main content area -->
<main class="main" id="app">
  <div class="loading"><div class="spinner"></div></div>
</main>

<!-- Config modal -->
<div class="cfg-wrap" id="cfgwrap">
  <div class="cfg-box">
    <div class="cfg-title">Connection Settings</div>
    <div class="fg">
      <label class="flbl">API Base URL</label>
      <input class="finp fm" id="cfg-base" placeholder="http://localhost:8000">
      <div class="fhint">URL where the IPAM server is running</div>
    </div>
    <div class="fg">
      <label class="flbl">API Key</label>
      <input class="finp fm" id="cfg-key" type="password" placeholder="your-api-key-here">
      <div class="fhint">Set via IPAM_API_KEY on the server</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:20px">
      <button class="btn btn-p" style="flex:1" onclick="saveCfg()">Save &amp; Connect</button>
      <button class="btn btn-s" onclick="closeCfg()">Cancel</button>
    </div>
  </div>
</div>

<!-- Drawer -->
<div class="overlay" id="doverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-hd">
    <div class="drawer-title" id="dtitle">—</div>
    <button class="btn btn-icon" onclick="closeDrawer()">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
    </button>
  </div>
  <div class="drawer-body" id="dbody"></div>
  <div class="drawer-foot" id="dfoot"></div>
</div>

<!-- Toasts -->
<div id="toasts"></div>

<script>
'use strict';

// ─── STATE ───────────────────────────────────────────────────────
const S = {
  key:  localStorage.getItem('ipam_key')  || '',
  base: localStorage.getItem('ipam_base') || 'http://localhost:8000',
  view: 'dashboard',
  vp:   {},
  subnets:  null,
  ips:      null,
  zones:    null,
  dSubnet:  null,
  dIPs:     null,
};

// ─── API ─────────────────────────────────────────────────────────
async function api(method, path, body = null) {
  const url = S.base.replace(/\/$/, '') + path;
  const headers = { 'Content-Type': 'application/json' };
  if (S.key) headers['Authorization'] = 'Bearer ' + S.key;
  const opts = { method, headers };
  if (body !== null) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  if (res.status === 204) return null;
  const data = await res.json().catch(() => null);
  if (!res.ok) {
    const detail = data?.detail;
    const msg = Array.isArray(detail)
      ? detail.map(d => d.msg || JSON.stringify(d)).join('; ')
      : (detail || `HTTP ${res.status}`);
    throw new Error(msg);
  }
  return data;
}

async function checkHealth() {
  try {
    await api('GET', '/health');
    S.health = 'ok';
    document.getElementById('hdot').className = 'health-dot ok';
    document.getElementById('htext').textContent = 'online';
    return true;
  } catch {
    S.health = 'err';
    document.getElementById('hdot').className = 'health-dot err';
    document.getElementById('htext').textContent = 'offline';
    return false;
  }
}

// ─── NAVIGATION ──────────────────────────────────────────────────
function nav(view, params = {}) {
  S.view = view; S.vp = params;
  document.querySelectorAll('.nav-btn').forEach(el => {
    const v = el.dataset.v;
    el.classList.toggle('active',
      v === view || (view === 'subnet-detail' && v === 'subnets'));
  });
  render();
}

// ─── HELPERS ─────────────────────────────────────────────────────
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

function set(html) { document.getElementById('app').innerHTML = html; }

function uColor(pct) {
  if (pct >= .95) return 'var(--red)';
  if (pct >= .75) return 'var(--amber)';
  return 'var(--green)';
}
function uPct(s) { return s.usable_hosts ? s.allocated_count / s.usable_hosts : 0; }
function uBar(s, h = 3) {
  const p = Math.min(100, Math.round(uPct(s) * 100));
  return `<div class="ubar" style="height:${h}px"><div class="ubar-fill" style="width:${p}%;background:${uColor(uPct(s))}"></div></div>`;
}
function badge(txt, type='blue') { return `<span class="badge badge-${type}">${txt}</span>`; }

function spinnerPage() { set('<div class="loading"><div class="spinner"></div></div>'); }

// ─── CONFIG ───────────────────────────────────────────────────────
function openCfg() {
  document.getElementById('cfg-base').value = S.base;
  document.getElementById('cfg-key').value  = S.key;
  document.getElementById('cfgwrap').classList.add('open');
}
function closeCfg() { document.getElementById('cfgwrap').classList.remove('open'); }
function saveCfg() {
  S.base = document.getElementById('cfg-base').value.trim() || 'http://localhost:8000';
  S.key  = document.getElementById('cfg-key').value.trim();
  localStorage.setItem('ipam_base', S.base);
  localStorage.setItem('ipam_key',  S.key);
  updateKeyBtn(); closeCfg(); checkHealth(); render();
}
function updateKeyBtn() {
  const btn = document.getElementById('keybtn');
  const lbl = document.getElementById('keylbl');
  if (S.key) { btn.classList.add('has-key'); lbl.textContent = S.key.slice(0,10) + '…'; }
  else        { btn.classList.remove('has-key'); lbl.textContent = 'Set API Key'; }
}

// ─── DRAWER ───────────────────────────────────────────────────────
function openDrawer(title, body, foot = '') {
  document.getElementById('dtitle').textContent = title;
  document.getElementById('dbody').innerHTML = body;
  document.getElementById('dfoot').innerHTML = foot;
  document.getElementById('drawer').classList.add('open');
  document.getElementById('doverlay').classList.add('open');
}
function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('doverlay').classList.remove('open');
}

// ─── TOAST ────────────────────────────────────────────────────────
function toast(msg, type = '', dur = 3200) {
  const c = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  c.appendChild(el);
  setTimeout(() => el.remove(), dur);
}

// ─── RENDER DISPATCHER ────────────────────────────────────────────
async function render() {
  switch (S.view) {
    case 'dashboard':     await renderDash(); break;
    case 'subnets':       await renderSubnets(); break;
    case 'subnet-detail': await renderSubnetDetail(); break;
    case 'ips':           await renderIPs(); break;
    case 'dns':           await renderDNS(); break;
  }
}

// ─── COUNTER ANIMATION ────────────────────────────────────────────
function countTo(id, target, suffix = '') {
  const el = document.getElementById(id);
  if (!el) return;
  let cur = 0;
  const step = Math.max(1, Math.ceil(target / 40));
  const t = setInterval(() => {
    cur = Math.min(cur + step, target);
    el.textContent = cur.toLocaleString() + suffix;
    if (cur >= target) clearInterval(t);
  }, 18);
}

// ─────────────────────────────────────────────────────────────────
// DASHBOARD
// ─────────────────────────────────────────────────────────────────
async function renderDash() {
  spinnerPage();
  try {
    const [subnets, ips, zones] = await Promise.all([
      api('GET', '/subnets/?limit=500'),
      api('GET', '/ip-addresses/?limit=1000'),
      api('GET', '/dns-zones/?limit=500'),
    ]);
    S.subnets = subnets; S.ips = ips; S.zones = zones;

    const totalUsable = subnets.reduce((a, s) => a + s.usable_hosts, 0);
    const utilPct = totalUsable > 0 ? Math.round(ips.length / totalUsable * 100) : 0;
    const ipv6n = subnets.filter(s => s.is_ipv6).length;
    const dnsIPs = ips.filter(i => i.dns_name).length;

    const subnetRows = subnets.slice(0, 6).map(s => `
      <tr onclick="nav('subnet-detail',{id:${s.id}})">
        <td class="mono">${esc(s.cidr)}</td>
        <td>${esc(s.name)}</td>
        <td style="min-width:100px">${uBar(s)}</td>
        <td class="mono-sm">${s.allocated_count}</td>
        <td class="mono-sm">${s.free_count}</td>
        <td>${badge(s.is_ipv6?'IPv6':'IPv4', s.is_ipv6?'cyan':'blue')}</td>
      </tr>`).join('');

    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">Network Overview</div>
          <div class="page-sub">IPAM system — ${new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})}</div>
        </div>
      </div>
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-lbl">Subnets</div>
          <div class="stat-val" id="sv-sub">0</div>
          <div class="stat-sub">${ipv6n} IPv6 · ${subnets.length - ipv6n} IPv4</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">Allocated IPs</div>
          <div class="stat-val" id="sv-ip">0</div>
          <div class="stat-sub">of ${totalUsable.toLocaleString()} usable</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">DNS Zones</div>
          <div class="stat-val" id="sv-dns">0</div>
          <div class="stat-sub">${dnsIPs} IPs with names</div>
        </div>
        <div class="stat-card">
          <div class="stat-lbl">Utilization</div>
          <div class="stat-val" id="sv-util">0%</div>
          <div class="stat-sub">${(totalUsable - ips.length).toLocaleString()} addresses free</div>
        </div>
      </div>
      ${subnets.length > 0 ? `
      <div class="card">
        <div class="card-hd">
          <div class="card-title">Subnets</div>
          <button class="btn btn-s btn-sm" onclick="nav('subnets')">View all →</button>
        </div>
        <table class="dtbl">
          <thead><tr><th>CIDR</th><th>Name</th><th>Utilization</th><th>Alloc</th><th>Free</th><th>Type</th></tr></thead>
          <tbody>${subnetRows}</tbody>
        </table>
      </div>` : `
      <div class="card"><div class="empty">
        <div class="empty-ico">⬡</div>
        <div class="empty-txt">No subnets yet</div>
        <div class="empty-hint">Create your first subnet to begin</div>
        <button class="btn btn-p" style="margin-top:10px" onclick="nav('subnets')">Create Subnet</button>
      </div></div>`}
    `);
    countTo('sv-sub', subnets.length);
    countTo('sv-ip',  ips.length);
    countTo('sv-dns', zones.length);
    countTo('sv-util', utilPct, '%');
  } catch (e) {
    set(`<div class="err-banner">${esc(e.message)}</div>`);
  }
}

// ─────────────────────────────────────────────────────────────────
// SUBNETS LIST
// ─────────────────────────────────────────────────────────────────
async function renderSubnets() {
  spinnerPage();
  try {
    const subnets = await api('GET', '/subnets/?limit=500');
    S.subnets = subnets;
    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">Subnets</div>
          <div class="page-sub">${subnets.length} subnet${subnets.length !== 1 ? 's' : ''}</div>
        </div>
        <button class="btn btn-p" onclick="openCreateSubnet()">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          New Subnet
        </button>
      </div>
      ${subnets.length === 0
        ? `<div class="card"><div class="empty">
            <div class="empty-ico">⬡</div>
            <div class="empty-txt">No subnets configured</div>
            <div class="empty-hint">Add your first subnet to start tracking IP space</div>
            <button class="btn btn-p" style="margin-top:10px" onclick="openCreateSubnet()">Create First Subnet</button>
           </div></div>`
        : `<div class="sc-grid">${subnets.map(scCard).join('')}</div>`
      }
    `);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

function scCard(s) {
  const p = Math.min(100, Math.round(uPct(s) * 100));
  const c = uColor(uPct(s));
  const utilBadge = p >= 95 ? badge('FULL','red') : p >= 75 ? badge('HIGH','amber') : '';
  return `
  <div class="sc" onclick="nav('subnet-detail',{id:${s.id}})">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2px">
      <div class="sc-cidr">${esc(s.cidr)}</div>
      <div style="display:flex;gap:4px">${utilBadge} ${badge(s.is_ipv6?'IPv6':'IPv4',s.is_ipv6?'cyan':'blue')}</div>
    </div>
    <div class="sc-name">${esc(s.name)}${s.description ? ' — ' + esc(s.description) : ''}</div>
    <div class="sc-ubar"><div class="sc-fill" style="width:${p}%;background:${c}"></div></div>
    <div class="sc-stats">
      <div><strong>${s.allocated_count}</strong> allocated</div>
      <div><strong>${s.free_count}</strong> free</div>
      <div><strong>${p}%</strong> used</div>
    </div>
  </div>`;
}

// ─────────────────────────────────────────────────────────────────
// SUBNET DETAIL
// ─────────────────────────────────────────────────────────────────
async function renderSubnetDetail() {
  const id = S.vp.id;
  spinnerPage();
  try {
    const [subnet, ips] = await Promise.all([
      api('GET', `/subnets/${id}`),
      api('GET', `/ip-addresses/?subnet_id=${id}&limit=1000`),
    ]);
    S.dSubnet = subnet; S.dIPs = ips;
    const p = uPct(subnet);
    const c = uColor(p);
    const pPct = Math.min(100, Math.round(p * 100));
    const showGrid = !subnet.is_ipv6 && subnet.total_hosts <= 4096;

    const ipRows = ips.map(ip => `
      <tr>
        <td class="mono">${esc(ip.address)}</td>
        <td class="mono-sm">${ip.dns_name ? esc(ip.dns_name) : '<span style="color:var(--text-3)">—</span>'}</td>
        <td style="color:var(--text-2);font-size:12px">${ip.description ? esc(ip.description) : '<span style="color:var(--text-3)">—</span>'}</td>
        <td style="text-align:right;white-space:nowrap">
          <button class="btn btn-icon btn-sm" title="Edit" onclick="openEditIP(${ip.id})">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
          <button class="btn btn-icon btn-sm" title="Delete" style="color:#f07070;margin-left:4px" onclick="delIP(${ip.id},'${esc(ip.address)}')">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
          </button>
        </td>
      </tr>`).join('');

    set(`
      <button class="back" onclick="nav('subnets')">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m15 18-6-6 6-6"/></svg>
        Back to Subnets
      </button>
      <div class="page-hd">
        <div>
          <div class="page-title" style="font-family:var(--font-mono);font-size:22px">${esc(subnet.cidr)}</div>
          <div class="page-sub">${esc(subnet.name)}${subnet.description ? ' — ' + esc(subnet.description) : ''}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-p btn-sm" onclick="openAllocate(${subnet.id})">
            <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
            Allocate Next IP
          </button>
          <button class="btn btn-s btn-sm" onclick="openAddIP(${subnet.id})">Add Specific IP</button>
        </div>
      </div>

      <div class="detail-lay">
        <div>
          <div class="card">
            <div class="card-hd">
              <div class="card-title">Allocated Addresses</div>
              ${badge(ips.length + ' allocated', 'blue')}
            </div>
            ${ips.length === 0
              ? `<div class="empty" style="padding:40px">
                   <div class="empty-txt">No IPs allocated</div>
                   <div class="empty-hint">Use "Allocate Next IP" to assign addresses from this subnet</div>
                 </div>`
              : `<table class="dtbl">
                   <thead><tr><th>Address</th><th>DNS Name</th><th>Description</th><th style="text-align:right">Actions</th></tr></thead>
                   <tbody>${ipRows}</tbody>
                 </table>`
            }
          </div>
        </div>

        <div>
          <!-- Stats panel -->
          <div class="card" style="margin-bottom:14px">
            <div class="card-hd"><div class="card-title">Subnet Details</div></div>
            <div style="padding:14px 16px">
              <div style="margin-bottom:10px">
                ${uBar(subnet, 5)}
                <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-2);margin-top:5px">
                  <span>${subnet.allocated_count} / ${subnet.usable_hosts} usable</span>
                  <span style="color:${c};font-weight:600">${pPct}%</span>
                </div>
              </div>
              <table class="detail-tbl">
                ${[
                  ['Netmask',   subnet.netmask],
                  ['Broadcast', subnet.broadcast],
                  ['1st Usable',subnet.first_usable],
                  ['Last Usable',subnet.last_usable],
                  ['Total',     subnet.total_hosts.toLocaleString()],
                  ['Usable',    subnet.usable_hosts.toLocaleString()],
                  ['Free',      subnet.free_count.toLocaleString()],
                  ['Type',      subnet.is_ipv6 ? 'IPv6' : 'IPv4'],
                ].map(([k,v])=>`<tr><td>${k}</td><td>${esc(String(v))}</td></tr>`).join('')}
              </table>
            </div>
          </div>

          <!-- IP Grid -->
          ${showGrid ? `
          <div class="card">
            <div class="card-hd">
              <div class="card-title">Address Map</div>
              <div style="font-size:10px;color:var(--text-3)">${subnet.total_hosts} addrs</div>
            </div>
            <div class="ipgrid-wrap">
              <div class="ipgrid-legend">
                <div class="ipgrid-legend-item">
                  <div class="ipgrid-legend-swatch" style="background:var(--bg-raised);border:1px solid var(--border)"></div>Free
                </div>
                <div class="ipgrid-legend-item">
                  <div class="ipgrid-legend-swatch" style="background:var(--cyan);box-shadow:0 0 4px var(--cyan-glow)"></div>Allocated
                </div>
                <div class="ipgrid-legend-item">
                  <div class="ipgrid-legend-swatch" style="background:var(--border-hi)"></div>Reserved
                </div>
              </div>
              <div id="ip-grid"></div>
            </div>
          </div>` : ''}
        </div>
      </div>
    `);

    if (showGrid) buildGrid(subnet, ips);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

// ─── IP GRID BUILDER ──────────────────────────────────────────────
function ip4ToInt(ip) { return ip.split('.').reduce((a,o) => (a<<8)+parseInt(o), 0) >>> 0; }
function intToIP4(n) { return [(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,n&255].join('.'); }
function intToHex32(n) { return '0'.repeat(24) + ((n>>>0).toString(16).padStart(8,'0')); }

function buildGrid(subnet, ips) {
  const el = document.getElementById('ip-grid');
  if (!el) return;

  const allocMap = new Map(ips.map(ip => [ip.address, ip]));
  const [addrPart, prefixStr] = subnet.cidr.split('/');
  const prefix = parseInt(prefixStr);
  const base = ip4ToInt(addrPart);
  const total = subnet.total_hosts;

  const cols = total <= 16 ? 4 : total <= 64 ? 8 : total <= 256 ? 16 : total <= 1024 ? 32 : 64;
  const sz   = total <= 256 ? 12 : total <= 1024 ? 7 : 4;
  const gap  = sz >= 7 ? 2 : 1;

  el.style.gridTemplateColumns = `repeat(${cols}, ${sz}px)`;
  el.style.gap = `${gap}px`;

  const frag = document.createDocumentFragment();
  for (let i = 0; i < total; i++) {
    const ipInt = base + i;
    const hex   = intToHex32(ipInt);
    const cell  = document.createElement('div');
    cell.className = 'ipc';
    cell.style.width  = sz + 'px';
    cell.style.height = sz + 'px';

    const isNet  = i === 0;
    const isBrdc = i === total - 1 && prefix < 31;

    if (isNet || isBrdc) {
      cell.classList.add('res');
      cell.title = intToIP4(ipInt) + (isNet ? ' (network)' : ' (broadcast)');
    } else if (allocMap.has(hex)) {
      const ipd = allocMap.get(hex);
      cell.classList.add('alloc');
      cell.title = ipd.address
        + (ipd.dns_name    ? '\n' + ipd.dns_name    : '')
        + (ipd.description ? '\n' + ipd.description : '');
    } else {
      cell.classList.add('free');
      cell.title = intToIP4(ipInt);
    }
    frag.appendChild(cell);
  }
  el.appendChild(frag);
}

// ─────────────────────────────────────────────────────────────────
// IP ADDRESSES LIST
// ─────────────────────────────────────────────────────────────────
async function renderIPs() {
  spinnerPage();
  try {
    const [ips, subs] = await Promise.all([
      api('GET', '/ip-addresses/?limit=1000'),
      S.subnets ? Promise.resolve(S.subnets) : api('GET', '/subnets/?limit=500'),
    ]);
    if (!S.subnets) S.subnets = subs;
    const smap = new Map(subs.map(s => [s.id, s]));
    window._allIPs = ips; window._smap = smap;

    const rows = ips.map(ip => ipRow(ip, smap)).join('');

    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">IP Addresses</div>
          <div class="page-sub">${ips.length} address${ips.length !== 1?'es':''} allocated</div>
        </div>
      </div>
      <div class="filters">
        <input class="fi" placeholder="Filter by address…"  id="fa" oninput="filterIPs()">
        <input class="fi" placeholder="Filter by DNS name…" id="fd" oninput="filterIPs()">
      </div>
      ${ips.length === 0
        ? `<div class="card"><div class="empty">
             <div class="empty-ico">◎</div>
             <div class="empty-txt">No IPs allocated</div>
             <div class="empty-hint">Allocate IPs from a subnet to see them here</div>
           </div></div>`
        : `<div class="card">
             <table class="dtbl">
               <thead><tr><th>Address</th><th>Subnet</th><th>DNS Name</th><th>Description</th><th>Type</th><th style="text-align:right">Actions</th></tr></thead>
               <tbody id="iptbody">${rows}</tbody>
             </table>
           </div>`
      }
    `);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

function ipRow(ip, smap) {
  const sub = smap?.get(ip.subnet_id);
  return `<tr data-addr="${esc(ip.address)}" data-dns="${esc(ip.dns_name||'')}">
    <td class="mono">${esc(ip.address)}</td>
    <td class="mono-sm">${sub ? esc(sub.cidr) : '#'+ip.subnet_id}</td>
    <td class="mono-sm">${ip.dns_name ? esc(ip.dns_name) : '<span style="color:var(--text-3)">—</span>'}</td>
    <td style="color:var(--text-2);font-size:12px">${ip.description ? esc(ip.description) : '<span style="color:var(--text-3)">—</span>'}</td>
    <td>${badge(ip.is_ipv6?'IPv6':'IPv4',ip.is_ipv6?'cyan':'blue')}</td>
    <td style="text-align:right;white-space:nowrap">
      <button class="btn btn-icon btn-sm" title="Edit" onclick="openEditIP(${ip.id})">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </button>
      <button class="btn btn-icon btn-sm" title="Delete" style="color:#f07070;margin-left:4px" onclick="delIP(${ip.id},'${esc(ip.address)}')">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
      </button>
    </td>
  </tr>`;
}

function filterIPs() {
  const fa = (document.getElementById('fa')?.value || '').toLowerCase();
  const fd = (document.getElementById('fd')?.value || '').toLowerCase();
  document.querySelectorAll('#iptbody tr').forEach(r => {
    const show = (!fa || (r.dataset.addr||'').includes(fa))
              && (!fd || (r.dataset.dns||'').includes(fd));
    r.style.display = show ? '' : 'none';
  });
}

// ─────────────────────────────────────────────────────────────────
// DNS ZONES
// ─────────────────────────────────────────────────────────────────
async function renderDNS() {
  spinnerPage();
  try {
    const zones = await api('GET', '/dns-zones/?limit=500');
    S.zones = zones;
    set(`
      <div class="page-hd">
        <div>
          <div class="page-title">DNS Zones</div>
          <div class="page-sub">${zones.length} zone${zones.length!==1?'s':''}</div>
        </div>
        <button class="btn btn-p" onclick="openCreateDNS()">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          New Zone
        </button>
      </div>
      ${zones.length === 0
        ? `<div class="card"><div class="empty">
             <div class="empty-ico">◑</div>
             <div class="empty-txt">No DNS zones</div>
             <div class="empty-hint">DNS zones are required to assign DNS names to IP addresses</div>
             <button class="btn btn-p" style="margin-top:10px" onclick="openCreateDNS()">Create First Zone</button>
           </div></div>`
        : `<div class="zc-grid">${zones.map(zCard).join('')}</div>`
      }
    `);
  } catch (e) { set(`<div class="err-banner">${esc(e.message)}</div>`); }
}

function zCard(z) {
  return `
  <div class="zc">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="zc-name">${esc(z.name)}</div>
        ${z.description ? `<div class="zc-desc">${esc(z.description)}</div>` : ''}
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0">
        <button class="btn btn-icon btn-sm" title="Edit" onclick="openEditDNS(${z.id})">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn btn-icon btn-sm" title="Delete" style="color:#f07070" onclick="delDNS(${z.id},'${esc(z.name)}')">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
        </button>
      </div>
    </div>
    <hr>
    <div class="zc-soa">
      <div class="zc-row">MNAME <span>${esc(z.soa.mname)}</span></div>
      <div class="zc-row">RNAME <span>${esc(z.soa.rname)}</span></div>
      <div class="zc-row">Serial <span>${z.soa.serial}</span></div>
      <div class="zc-row">Refresh <span>${z.soa.refresh}s</span></div>
      <div class="zc-row">Retry <span>${z.soa.retry}s</span></div>
      <div class="zc-row">Expire <span>${z.soa.expire}s</span></div>
    </div>
  </div>`;
}

// ─────────────────────────────────────────────────────────────────
// CREATE / EDIT FORMS
// ─────────────────────────────────────────────────────────────────

// ── CREATE SUBNET ────────────────────────────────────────────────
function openCreateSubnet() {
  openDrawer('New Subnet', `
    <div class="fg">
      <label class="flbl">CIDR Notation *</label>
      <input class="finp fm" id="f-cidr" placeholder="192.168.1.0/24">
      <div class="fhint">IPv4 or IPv6, e.g. 10.0.0.0/8 or 2001:db8::/32</div>
    </div>
    <div class="fg">
      <label class="flbl">Name *</label>
      <input class="finp" id="f-name" placeholder="e.g. Corporate LAN">
    </div>
    <div class="fg">
      <label class="flbl">Description</label>
      <input class="finp" id="f-desc" placeholder="Optional description">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `, `
    <button class="btn btn-p" style="flex:1" onclick="submitCreateSubnet()">Create Subnet</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}

async function submitCreateSubnet() {
  const cidr = document.getElementById('f-cidr').value.trim();
  const name = document.getElementById('f-name').value.trim();
  const desc = document.getElementById('f-desc').value.trim();
  const err  = document.getElementById('ferr');
  err.style.display = 'none';
  if (!cidr || !name) { err.textContent = 'CIDR and Name are required'; err.style.display = 'block'; return; }
  try {
    await api('POST', '/subnets/', { cidr, name, description: desc || null });
    closeDrawer(); toast('Subnet created', 'ok'); S.subnets = null;
    await renderSubnets();
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

// ── ALLOCATE NEXT IP ─────────────────────────────────────────────
function openAllocate(subnetId) {
  openDrawer('Allocate Next IP', `
    <p style="font-size:13px;color:var(--text-2);margin-bottom:18px">
      Assigns the lowest available address in subnet <strong style="font-family:var(--font-mono)">${esc(S.dSubnet?.cidr||'')}</strong>.
    </p>
    <div class="fg">
      <label class="flbl">DNS Name (optional)</label>
      <input class="finp fm" id="f-dns" placeholder="host.example.com">
      <div class="fhint">Must belong to an existing DNS zone</div>
    </div>
    <div class="fg">
      <label class="flbl">Description (optional)</label>
      <input class="finp" id="f-desc" placeholder="Purpose or owner of this address">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
    <div id="fresult" style="display:none" class="result-box">
      <div class="result-lbl">Allocated Address</div>
      <div class="result-val" id="fresult-addr">—</div>
    </div>
  `, `
    <button class="btn btn-p" id="fsub" style="flex:1" onclick="submitAllocate(${subnetId})">Allocate IP</button>
    <button class="btn btn-s" onclick="closeDrawer()">Done</button>
  `);
}

async function submitAllocate(subnetId) {
  const dns  = document.getElementById('f-dns').value.trim();
  const desc = document.getElementById('f-desc').value.trim();
  const err  = document.getElementById('ferr');
  err.style.display = 'none';
  try {
    const r = await api('POST', `/subnets/${subnetId}/allocate`, { dns_name: dns||null, description: desc||null });
    document.getElementById('fresult').style.display = 'block';
    document.getElementById('fresult-addr').textContent = r.address;
    document.getElementById('fsub').disabled = true;
    toast('Allocated ' + r.address, 'ok');
    setTimeout(async () => { closeDrawer(); await renderSubnetDetail(); }, 1600);
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

// ── ADD SPECIFIC IP ──────────────────────────────────────────────
function openAddIP(subnetId) {
  openDrawer('Add Specific IP', `
    <div class="fg">
      <label class="flbl">IP Address *</label>
      <input class="finp fm" id="f-addr" placeholder="192.168.1.42">
    </div>
    <div class="fg">
      <label class="flbl">DNS Name (optional)</label>
      <input class="finp fm" id="f-dns" placeholder="host.example.com">
    </div>
    <div class="fg">
      <label class="flbl">Description (optional)</label>
      <input class="finp" id="f-desc" placeholder="">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `, `
    <button class="btn btn-p" style="flex:1" onclick="submitAddIP(${subnetId})">Add IP</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}

async function submitAddIP(subnetId) {
  const address = document.getElementById('f-addr').value.trim();
  const dns     = document.getElementById('f-dns').value.trim();
  const desc    = document.getElementById('f-desc').value.trim();
  const err     = document.getElementById('ferr');
  err.style.display = 'none';
  if (!address) { err.textContent = 'IP address is required'; err.style.display = 'block'; return; }
  try {
    await api('POST', '/ip-addresses/', { address, subnet_id: subnetId, dns_name: dns||null, description: desc||null });
    closeDrawer(); toast('IP address added', 'ok'); await renderSubnetDetail();
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

// ── EDIT IP ──────────────────────────────────────────────────────
async function openEditIP(ipId) {
  // Find from cached state
  let ip = (S.dIPs || []).find(i => i.id === ipId)
        || (S.ips  || []).find(i => i.id === ipId);
  if (!ip) { try { ip = await api('GET', `/ip-addresses/${ipId}`); } catch(e) { toast(e.message,'err'); return; } }

  openDrawer(`Edit ${ip.address}`, `
    <div style="font-family:var(--font-mono);font-size:20px;color:var(--text);margin-bottom:18px">${esc(ip.address)}</div>
    <div class="fg">
      <label class="flbl">DNS Name</label>
      <input class="finp fm" id="f-dns" value="${esc(ip.dns_name||'')}" placeholder="host.example.com">
      <div class="fhint">Clear to remove DNS association</div>
    </div>
    <div class="fg">
      <label class="flbl">Description</label>
      <input class="finp" id="f-desc" value="${esc(ip.description||'')}" placeholder="">
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `, `
    <button class="btn btn-p" style="flex:1" onclick="submitEditIP(${ip.id})">Save Changes</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}

async function submitEditIP(ipId) {
  const dns  = document.getElementById('f-dns').value.trim();
  const desc = document.getElementById('f-desc').value.trim();
  const err  = document.getElementById('ferr');
  err.style.display = 'none';
  try {
    await api('PUT', `/ip-addresses/${ipId}`, { dns_name: dns||null, description: desc||null });
    closeDrawer(); toast('Updated', 'ok');
    if (S.view === 'subnet-detail') await renderSubnetDetail(); else await renderIPs();
  } catch (e) { err.textContent = e.message; err.style.display = 'block'; }
}

// ── DELETE IP ────────────────────────────────────────────────────
async function delIP(ipId, address) {
  if (!confirm(`Delete ${address}?\nThis frees the address for future allocation.`)) return;
  try {
    await api('DELETE', `/ip-addresses/${ipId}`);
    toast(address + ' released', 'ok');
    if (S.view === 'subnet-detail') await renderSubnetDetail(); else await renderIPs();
  } catch (e) { toast(e.message, 'err'); }
}

// ── DNS ZONE FORM ────────────────────────────────────────────────
function dnsForm(z = null) {
  const s = z?.soa || {};
  return `
    <div class="fg">
      <label class="flbl">Zone Name *</label>
      <input class="finp fm" id="f-zname" value="${esc(z?.name||'')}" placeholder="example.com">
    </div>
    <div class="fg">
      <label class="flbl">Description</label>
      <input class="finp" id="f-zdesc" value="${esc(z?.description||'')}" placeholder="">
    </div>
    <div class="soa-head">SOA Record</div>
    <div class="grid2">
      <div class="fg">
        <label class="flbl">MNAME *</label>
        <input class="finp fm" id="f-mname" value="${esc(s.mname||'')}" placeholder="ns1.example.com">
        <div class="fhint">Primary nameserver</div>
      </div>
      <div class="fg">
        <label class="flbl">RNAME *</label>
        <input class="finp fm" id="f-rname" value="${esc(s.rname||'')}" placeholder="hostmaster.example.com">
        <div class="fhint">Responsible party</div>
      </div>
    </div>
    <div class="grid3">
      <div class="fg">
        <label class="flbl">Serial</label>
        <input class="finp fm" id="f-serial" type="number" value="${s.serial??1}">
      </div>
      <div class="fg">
        <label class="flbl">Refresh (s)</label>
        <input class="finp fm" id="f-refresh" type="number" value="${s.refresh??3600}">
      </div>
      <div class="fg">
        <label class="flbl">Retry (s)</label>
        <input class="finp fm" id="f-retry" type="number" value="${s.retry??600}">
      </div>
    </div>
    <div class="grid2">
      <div class="fg">
        <label class="flbl">Expire (s)</label>
        <input class="finp fm" id="f-expire" type="number" value="${s.expire??604800}">
      </div>
      <div class="fg">
        <label class="flbl">Minimum (s)</label>
        <input class="finp fm" id="f-minimum" type="number" value="${s.minimum??86400}">
      </div>
    </div>
    <div id="ferr" class="err-banner" style="display:none"></div>
  `;
}

function getDNSData() {
  return {
    name:        document.getElementById('f-zname').value.trim(),
    description: document.getElementById('f-zdesc').value.trim() || null,
    soa: {
      mname:   document.getElementById('f-mname').value.trim(),
      rname:   document.getElementById('f-rname').value.trim(),
      serial:  parseInt(document.getElementById('f-serial').value)  || 1,
      refresh: parseInt(document.getElementById('f-refresh').value) || 3600,
      retry:   parseInt(document.getElementById('f-retry').value)   || 600,
      expire:  parseInt(document.getElementById('f-expire').value)  || 604800,
      minimum: parseInt(document.getElementById('f-minimum').value) || 86400,
    }
  };
}

function openCreateDNS() {
  openDrawer('New DNS Zone', dnsForm(), `
    <button class="btn btn-p" style="flex:1" onclick="submitCreateDNS()">Create Zone</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}
async function submitCreateDNS() {
  const d = getDNSData(); const err = document.getElementById('ferr'); err.style.display = 'none';
  if (!d.name||!d.soa.mname||!d.soa.rname) { err.textContent='Name, MNAME and RNAME are required'; err.style.display='block'; return; }
  try { await api('POST','/dns-zones/',d); closeDrawer(); toast('Zone created','ok'); await renderDNS(); }
  catch(e) { err.textContent=e.message; err.style.display='block'; }
}

async function openEditDNS(zoneId) {
  let z = (S.zones||[]).find(z=>z.id===zoneId);
  if (!z) { try { z = await api('GET',`/dns-zones/${zoneId}`); } catch(e) { toast(e.message,'err'); return; } }
  openDrawer(`Edit ${z.name}`, dnsForm(z), `
    <button class="btn btn-p" style="flex:1" onclick="submitEditDNS(${z.id})">Save Changes</button>
    <button class="btn btn-s" onclick="closeDrawer()">Cancel</button>
  `);
}
async function submitEditDNS(zoneId) {
  const d=getDNSData(); const err=document.getElementById('ferr'); err.style.display='none';
  try { await api('PUT',`/dns-zones/${zoneId}`,d); closeDrawer(); toast('Zone updated','ok'); await renderDNS(); }
  catch(e) { err.textContent=e.message; err.style.display='block'; }
}

async function delDNS(zoneId, name) {
  if (!confirm(`Delete DNS zone '${name}'?`)) return;
  try { await api('DELETE',`/dns-zones/${zoneId}`); toast(`'${name}' deleted`,'ok'); await renderDNS(); }
  catch(e) { toast(e.message,'err'); }
}

// ─── INIT ─────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', async () => {
  updateKeyBtn();
  await checkHealth();
  nav('dashboard');
});
</script>
</body>
</html>
